<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kayleh.top/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kayleh.top/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github-style.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/light.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/dark.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/syntax.css' />
    <title>Java高性能高并发秒杀系统(3) - Kayleh</title>
    
    <link rel="icon" type="image/x-icon" href='https://kayleh.top/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="1. 实现分布式Session 1.1 原理图解  作用：用Redis存储Session值，在Redis中通过token值来获取用户信息  1.2 每次登陆，将Session的过期时间进行修正  怎么说呢？我们的Session值固定过期时间为30min，要在每次登陆的时候，以当前时间继续顺延30分钟 我们的解决方法就是，每次登陆时，重新再添加一次Cookie，则能够完成时间延长  以下是封装addCookie()的方法
private void addCookie(HttpServletResponse response, MiaoShaUser user, String token) { //首次登陆的时候，需要将Cookie存入Redis  redisService.set(MiaoShaUserKey.getTokenPrefix,token,user); Cookie cookie = new Cookie(COOKIE_NAME_TOKEN, token); cookie.setMaxAge(MiaoShaUserKey.getTokenPrefix.expireSeconds()); //设置为根目录，则可以在整个应用范围内使用cookie  cookie.setPath(&amp;#34;/&amp;#34;); response.addCookie(cookie); } 123456789 1.3 Cookie有什么用？ 在我们这个项目中，Cookie中存储的是token值。而这个token值是和用户信息是一一绑定的，将会存储在Redis中。我们从Cookie中获取到token，从而就可以获取到用户，下面简化代码的过程，便是对这一过程的演示。
1.4 分布式Session的理解 服务器中的原生session是无法满足需求的，因为用户的请求有可能随机落入到不同的服务器中，这样的结果将会导致用户的session丢失，传统做法中有解决方案，是进行session同步，将一个服务器上的session进行同步到另一个服务器上，在一个集群中无论你访问哪个服务器都可以共享，但是这种方法有个明显缺陷，就是性能问题，传输有时延问题，其次这样每台服务器的session重复拥有，这样其内存必然受到影响，如果只有几台服务器还好，如果是十台，二十台服务器呢？这种恐怖的场景会是什么样的体验呢，我就无法得知了。
那么我们应该如何有效的解决这样的问题呢，我们可以使用传说中的token来解决，简单明了的说就是用户每次登陆的时候生成一个类似sessionId的东西（也就是所谓的token，这将是全局的唯一标识，如UUID，作用类似于（sessionId）），将其写到cookie当中传送给客户端，客户端对数据库访问过程中不断上传这个token，而我们服务端拿到这个token就可以获取用户的信息，这个道理其实在很多地方是相通的，比如我们容器中实现原生session，也是将生成的id写入cookie当中。
 2. 解决注解获取参数造成的代码冗余 我们看一下，如下代码
@RequestMapping(&amp;#34;/to_list&amp;#34;) public String toList(Model model, @CookieValue(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String cookieToken, @RequestParam(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String paramToken, ){ if(StringUtils." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-2/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Java高性能高并发秒杀系统(3) - Kayleh" />
<meta name="twitter:description"
  content="1. 实现分布式Session 1.1 原理图解  作用：用Redis存储Session值，在Redis中通过token值来获取用户信息  1.2 每次登陆，将Session的过期时间进行修正  怎么说呢？我们的Session值固定过期时间为30min，要在每次登陆的时候，以当前时间继续顺延30分钟 我们的解决方法就是，每次登陆时，重新再添加一次Cookie，则能够完成时间延长  以下是封装addCookie()的方法
private void addCookie(HttpServletResponse response, MiaoShaUser user, String token) { //首次登陆的时候，需要将Cookie存入Redis  redisService.set(MiaoShaUserKey.getTokenPrefix,token,user); Cookie cookie = new Cookie(COOKIE_NAME_TOKEN, token); cookie.setMaxAge(MiaoShaUserKey.getTokenPrefix.expireSeconds()); //设置为根目录，则可以在整个应用范围内使用cookie  cookie.setPath(&amp;#34;/&amp;#34;); response.addCookie(cookie); } 123456789 1.3 Cookie有什么用？ 在我们这个项目中，Cookie中存储的是token值。而这个token值是和用户信息是一一绑定的，将会存储在Redis中。我们从Cookie中获取到token，从而就可以获取到用户，下面简化代码的过程，便是对这一过程的演示。
1.4 分布式Session的理解 服务器中的原生session是无法满足需求的，因为用户的请求有可能随机落入到不同的服务器中，这样的结果将会导致用户的session丢失，传统做法中有解决方案，是进行session同步，将一个服务器上的session进行同步到另一个服务器上，在一个集群中无论你访问哪个服务器都可以共享，但是这种方法有个明显缺陷，就是性能问题，传输有时延问题，其次这样每台服务器的session重复拥有，这样其内存必然受到影响，如果只有几台服务器还好，如果是十台，二十台服务器呢？这种恐怖的场景会是什么样的体验呢，我就无法得知了。
那么我们应该如何有效的解决这样的问题呢，我们可以使用传说中的token来解决，简单明了的说就是用户每次登陆的时候生成一个类似sessionId的东西（也就是所谓的token，这将是全局的唯一标识，如UUID，作用类似于（sessionId）），将其写到cookie当中传送给客户端，客户端对数据库访问过程中不断上传这个token，而我们服务端拿到这个token就可以获取用户的信息，这个道理其实在很多地方是相通的，比如我们容器中实现原生session，也是将生成的id写入cookie当中。
 2. 解决注解获取参数造成的代码冗余 我们看一下，如下代码
@RequestMapping(&amp;#34;/to_list&amp;#34;) public String toList(Model model, @CookieValue(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String cookieToken, @RequestParam(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String paramToken, ){ if(StringUtils." />
<meta name="twitter:site" content="https://kayleh.top" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kayleh.top">


<meta property="og:type" content="article" />
<meta property="og:title" content="Java高性能高并发秒杀系统(3) - Kayleh">
<meta property="og:description"
  content="1. 实现分布式Session 1.1 原理图解  作用：用Redis存储Session值，在Redis中通过token值来获取用户信息  1.2 每次登陆，将Session的过期时间进行修正  怎么说呢？我们的Session值固定过期时间为30min，要在每次登陆的时候，以当前时间继续顺延30分钟 我们的解决方法就是，每次登陆时，重新再添加一次Cookie，则能够完成时间延长  以下是封装addCookie()的方法
private void addCookie(HttpServletResponse response, MiaoShaUser user, String token) { //首次登陆的时候，需要将Cookie存入Redis  redisService.set(MiaoShaUserKey.getTokenPrefix,token,user); Cookie cookie = new Cookie(COOKIE_NAME_TOKEN, token); cookie.setMaxAge(MiaoShaUserKey.getTokenPrefix.expireSeconds()); //设置为根目录，则可以在整个应用范围内使用cookie  cookie.setPath(&amp;#34;/&amp;#34;); response.addCookie(cookie); } 123456789 1.3 Cookie有什么用？ 在我们这个项目中，Cookie中存储的是token值。而这个token值是和用户信息是一一绑定的，将会存储在Redis中。我们从Cookie中获取到token，从而就可以获取到用户，下面简化代码的过程，便是对这一过程的演示。
1.4 分布式Session的理解 服务器中的原生session是无法满足需求的，因为用户的请求有可能随机落入到不同的服务器中，这样的结果将会导致用户的session丢失，传统做法中有解决方案，是进行session同步，将一个服务器上的session进行同步到另一个服务器上，在一个集群中无论你访问哪个服务器都可以共享，但是这种方法有个明显缺陷，就是性能问题，传输有时延问题，其次这样每台服务器的session重复拥有，这样其内存必然受到影响，如果只有几台服务器还好，如果是十台，二十台服务器呢？这种恐怖的场景会是什么样的体验呢，我就无法得知了。
那么我们应该如何有效的解决这样的问题呢，我们可以使用传说中的token来解决，简单明了的说就是用户每次登陆的时候生成一个类似sessionId的东西（也就是所谓的token，这将是全局的唯一标识，如UUID，作用类似于（sessionId）），将其写到cookie当中传送给客户端，客户端对数据库访问过程中不断上传这个token，而我们服务端拿到这个token就可以获取用户的信息，这个道理其实在很多地方是相通的，比如我们容器中实现原生session，也是将生成的id写入cookie当中。
 2. 解决注解获取参数造成的代码冗余 我们看一下，如下代码
@RequestMapping(&amp;#34;/to_list&amp;#34;) public String toList(Model model, @CookieValue(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String cookieToken, @RequestParam(value = MiaoShaUserService.COOKIE_NAME_TOKEN,required = false) String paramToken, ){ if(StringUtils." />
<meta property="og:url" content="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-2/" />
<meta property="og:site_name" content="Java高性能高并发秒杀系统(3)" />
<meta property="og:image"
  content="https://kayleh.top">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-11-07 20:12:45 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kayleh.top">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kayleh.top">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kayleh.top">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kayleh.top">
                  <img class=" avatar-user"
                    src="http://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kayleh.top">Kayleh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-2/">Java高性能高并发秒杀系统(3)</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 07 Nov 2020 20:12:45 &#43;0800"
                    class="no-wrap">
                    Sat, 07 Nov 2020 20:12:45 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    1928 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/project">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      project
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><h2 id="1-实现分布式session">1. 实现分布式Session</h2>
<h3 id="11-原理图解">1.1 原理图解</h3>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200710172401826.png" alt="在这里插入图片描述"></p>
<ul>
<li><strong>作用</strong>：用<code>Redis存储Session值</code>，在Redis中<code>通过token值来获取用户信息</code></li>
</ul>
<h3 id="12-每次登陆将session的过期时间进行修正">1.2 每次登陆，将Session的过期时间进行修正</h3>
<ul>
<li>怎么说呢？我们的Session值固定过期时间为30min，要在每次登陆的时候，<code>以当前时间继续顺延30分钟</code></li>
<li>我们的<code>解决方法</code>就是，每次登陆时，重新再添加一次Cookie，则能够完成时间延长</li>
</ul>
<p>以下是<code>封装addCookie()</code>的方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addCookie</span><span style="color:#f92672">(</span>HttpServletResponse response<span style="color:#f92672">,</span> MiaoShaUser user<span style="color:#f92672">,</span> String token<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    	<span style="color:#75715e">//首次登陆的时候，需要将Cookie存入Redis
</span><span style="color:#75715e"></span>        redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>MiaoShaUserKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getTokenPrefix</span><span style="color:#f92672">,</span>token<span style="color:#f92672">,</span>user<span style="color:#f92672">);</span>
        Cookie cookie <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Cookie<span style="color:#f92672">(</span>COOKIE_NAME_TOKEN<span style="color:#f92672">,</span> token<span style="color:#f92672">);</span>
        cookie<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxAge</span><span style="color:#f92672">(</span>MiaoShaUserKey<span style="color:#f92672">.</span><span style="color:#a6e22e">getTokenPrefix</span><span style="color:#f92672">.</span><span style="color:#a6e22e">expireSeconds</span><span style="color:#f92672">());</span>
        <span style="color:#75715e">//设置为根目录，则可以在整个应用范围内使用cookie
</span><span style="color:#75715e"></span>        cookie<span style="color:#f92672">.</span><span style="color:#a6e22e">setPath</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">);</span>
        response<span style="color:#f92672">.</span><span style="color:#a6e22e">addCookie</span><span style="color:#f92672">(</span>cookie<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
123456789
</code></pre></div><h3 id="13-cookie有什么用">1.3 Cookie有什么用？</h3>
<p>在我们这个项目中，Cookie中存储的是token值。而这个token值是和用户信息是一一绑定的，将会存储在Redis中。我们从Cookie中获取到token，从而就可以获取到用户，下面简化代码的过程，便是对这一过程的演示。</p>
<h3 id="14-分布式session的理解">1.4 分布式Session的理解</h3>
<p>服务器中的原生session是无法满足需求的，因为用户的请求有可能随机落入到不同的服务器中，这样的结果将会导致用户的session丢失，传统做法中有解决方案，是进行session同步，将一个服务器上的session进行同步到另一个服务器上，在一个集群中无论你访问哪个服务器都可以共享，但是这种方法有个明显缺陷，就是性能问题，传输有时延问题，其次这样每台服务器的session重复拥有，这样其内存必然受到影响，如果只有几台服务器还好，如果是十台，二十台服务器呢？这种恐怖的场景会是什么样的体验呢，我就无法得知了。</p>
<p>那么我们应该如何有效的解决这样的问题呢，我们可以使用传说中的token来解决，简单明了的说就是用户每次登陆的时候生成一个类似sessionId的东西（也就是所谓的token，这将是全局的唯一标识，如UUID，作用类似于（sessionId）），将其写到cookie当中传送给客户端，客户端对数据库访问过程中不断上传这个token，而我们服务端拿到这个token就可以获取用户的信息，这个道理其实在很多地方是相通的，比如我们容器中实现原生session，也是将生成的id写入cookie当中。</p>
<hr>
<h2 id="2-解决注解获取参数造成的代码冗余">2. 解决注解获取参数造成的代码冗余</h2>
<p><strong>我们看一下，如下代码</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/to_list&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toList</span><span style="color:#f92672">(</span>Model model<span style="color:#f92672">,</span>
                         <span style="color:#a6e22e">@CookieValue</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> MiaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">COOKIE_NAME_TOKEN</span><span style="color:#f92672">,</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> String cookieToken<span style="color:#f92672">,</span>
                         <span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> MiaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">COOKIE_NAME_TOKEN</span><span style="color:#f92672">,</span>required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> String paramToken<span style="color:#f92672">,</span>
                         <span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>cookieToken<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>paramToken<span style="color:#f92672">)){</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>

        String token <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>paramToken<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> cookieToken <span style="color:#f92672">:</span> paramToken<span style="color:#f92672">;</span>
        MiaoShaUser user <span style="color:#f92672">=</span> miaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">getByToken</span><span style="color:#f92672">(</span>response<span style="color:#f92672">,</span>token<span style="color:#f92672">);</span>
        model<span style="color:#f92672">.</span><span style="color:#a6e22e">addAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">,</span>user<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;goods_list&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
123456789101112131415
</code></pre></div><ul>
<li><code>@CookieValue</code>：这个注解能够根据参数value在Cookie中获取值</li>
<li><code>@RequestParam</code>：该注解让我们在Request中能获取参数，解决的主要是，移动手机端不使用Cookie存值的问题</li>
</ul>
<p>我们在如上代码中，可以发现，注解标记获取参数，使得代码很厚重，若我们每次想从Cookie中获取token值时，都需要复现如上代码，所以我们要把它剖离出来</p>
<h3 id="21-webmvcconfigureradapter">2.1 WebMvcConfigurerAdapter</h3>
<p>在这个项目中，我们采用的是继承<code>WebMvcConfigurerAdapter</code>，重写其中<code>addArgumentResolvers()方法</code>，该方法实现的是<code>参数解析的功能</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebConfig</span> <span style="color:#66d9ef">extends</span> WebMvcConfigurerAdapter<span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    UserArgumentResolver userArgumentResolver<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addArgumentResolvers</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>HandlerMethodArgumentResolver<span style="color:#f92672">&gt;</span> argumentResolvers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addArgumentResolvers</span><span style="color:#f92672">(</span>argumentResolvers<span style="color:#f92672">);</span>
        argumentResolvers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>userArgumentResolver<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
123456789101112
</code></pre></div><h4 id="211-该方法在spring50之后就过时了">2.1.1 该方法在Spring5.0之后就过时了</h4>
<ul>
<li><strong>现用方式</strong></li>
</ul>
<ol>
<li>实现WebMvcConfigurer</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebMvcConfg</span> <span style="color:#66d9ef">implements</span> WebMvcConfigurer <span style="color:#f92672">{</span>
	<span style="color:#75715e">//TODO
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
1234
</code></pre></div><ol>
<li>继承WebMVCConfigurationSupport</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebMvcConfg</span> <span style="color:#66d9ef">extends</span> WebMvcConfigurationSupport <span style="color:#f92672">{</span>
	<span style="color:#75715e">//TODO
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
1234
</code></pre></div><h3 id="22-在argumentresolvers中添加我们的参数解析逻辑">2.2 在argumentResolvers中添加我们的参数解析逻辑</h3>
<ul>
<li>首先，我们应该搞清楚，我们想要的参数是什么？回看代码冗余的问题，最终我们想获取的是<code>MiaoShaUser</code>，这下我们进行代码的编写</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Service</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserArgumentResolver</span> <span style="color:#66d9ef">implements</span> HandlerMethodArgumentResolver <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    MiaoShaUserService miaoShaUserService<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supportsParameter</span><span style="color:#f92672">(</span>MethodParameter methodParameter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//这个方法判断参数类型是否支持
</span><span style="color:#75715e"></span>        Class<span style="color:#f92672">&lt;?&gt;</span> clazz <span style="color:#f92672">=</span> methodParameter<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameterType</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> clazz <span style="color:#f92672">==</span> MiaoShaUser<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">resolveArgument</span><span style="color:#f92672">(</span>MethodParameter methodParameter<span style="color:#f92672">,</span> ModelAndViewContainer modelAndViewContainer<span style="color:#f92672">,</span>
                                  NativeWebRequest nativeWebRequest<span style="color:#f92672">,</span> WebDataBinderFactory webDataBinderFactory<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">//这个方法实现对参数的处理
</span><span style="color:#75715e"></span>        HttpServletRequest request <span style="color:#f92672">=</span> nativeWebRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getNativeRequest</span><span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        HttpServletResponse response <span style="color:#f92672">=</span> nativeWebRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getNativeResponse</span><span style="color:#f92672">(</span>HttpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

        String paramToken <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>miaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">COOKIE_NAME_TOKEN</span><span style="color:#f92672">);</span>
        String cookieToken <span style="color:#f92672">=</span> getCookieValue<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> miaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">COOKIE_NAME_TOKEN</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>paramToken<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>cookieToken<span style="color:#f92672">)){</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        String token <span style="color:#f92672">=</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">(</span>paramToken<span style="color:#f92672">)</span> <span style="color:#f92672">?</span> cookieToken <span style="color:#f92672">:</span> paramToken<span style="color:#f92672">;</span>

        <span style="color:#66d9ef">return</span> miaoShaUserService<span style="color:#f92672">.</span><span style="color:#a6e22e">getByToken</span><span style="color:#f92672">(</span>response<span style="color:#f92672">,</span>token<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getCookieValue</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span>String cookieName<span style="color:#f92672">){</span>
        Cookie<span style="color:#f92672">[]</span> cookies <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getCookies</span><span style="color:#f92672">();</span>

        <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>Cookie cookie <span style="color:#f92672">:</span> cookies<span style="color:#f92672">){</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>cookie<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>cookieName<span style="color:#f92672">)){</span>
                <span style="color:#66d9ef">return</span> cookie<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>实现<code>HandlerMethodArgumentResolver接口</code>，必须重写其中的两个方法，<code>supportsParameter()</code>和<code>resolveArgument()</code></li>
<li>前者是对我们要进行解析的<code>参数类型</code>进行判断，符合才执行后者</li>
<li>后者是我们对<code>参数的处理逻辑</code>，两种情况，一是从request中获取token值，二是从cookie中拿取token值，根据token值来获取到对应的user</li>
</ul>
<p>以上就将我们需要的参数的处理逻辑实现了，在Mvc配置中，用<code>argumentResolvers.add(userArgumentResolver)</code>方法进行添加即可，这样我们再想获取user的时候就简单多了，如下</p>
<h3 id="23-如此清爽的代码">2.3 如此清爽的代码</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/to_list&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toList</span><span style="color:#f92672">(</span>Model model<span style="color:#f92672">,</span>MiaoShaUser user<span style="color:#f92672">){</span>
        model<span style="color:#f92672">.</span><span style="color:#a6e22e">addAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">,</span>user<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;goods_list&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
12345
</code></pre></div><p>省去了@CookieValue和@RequestParam注解的冗余，而且我们对user的获取也方便多了</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kayleh.top">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://kayleh.top/js/github-style.js"></script>



</html>