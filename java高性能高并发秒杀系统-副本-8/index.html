<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kayleh.top/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kayleh.top/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github-style.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/light.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/dark.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/syntax.css' />
    <title>Java高性能高并发秒杀系统(9) - Kayleh</title>
    
    <link rel="icon" type="image/x-icon" href='https://kayleh.top/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="1. 动态秒杀地址 1.1 前端的改变 之前我们实现秒杀的时候是直接跳转到秒杀接口，使得我们每次的秒杀地址都是一样的，这样具有安全隐患，所以，我们将其改为动态地址，通过在前端上写一个方法进行跳转，如下所示。
 它会先跳转到/miaosha/path，获取秒杀地址中的path值，将其存储在Redis中 然后携带path值去访问真正的秒杀方法，在其中将path值与Redis中的值进行比较，一致才能继续秒杀   1.2 获取路径的Java代码 @ResponseBody @RequestMapping(value = &amp;#34;/path&amp;#34;,method = RequestMethod.GET) public Result&amp;lt;String&amp;gt; getMiaoshaPath(MiaoShaUser user,@RequestParam(&amp;#34;goodsId&amp;#34;)long goodsId, @RequestParam(value = &amp;#34;verifyCode&amp;#34;,defaultValue = &amp;#34;0&amp;#34;)int verifyCode){ if(user == null) return Result.error(CodeMsg.SESSION_ERROR); String path = miaoshaService.createMiaoshaPath(user,goodsId); return Result.success(path); } 123456789101112  先调用createMiaoshaPath()方法，在其中会创建一串随机值，并且存储到Redis中，具体方法如下，执行完之后将路径值返回到前端  public String createMiaoshaPath(MiaoShaUser user, long goodsId) { if(user == null || goodsId &amp;lt;= 0) return null; String str = MD5Util.md5(UUIDUtil.getUUID()); redisService.set(MiaoshaKey.miaoshaPathPrefix,user.getId() &#43; &amp;#34;_&amp;#34; &#43; goodsId,str); return str; } 123456789 1." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-8/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Java高性能高并发秒杀系统(9) - Kayleh" />
<meta name="twitter:description"
  content="1. 动态秒杀地址 1.1 前端的改变 之前我们实现秒杀的时候是直接跳转到秒杀接口，使得我们每次的秒杀地址都是一样的，这样具有安全隐患，所以，我们将其改为动态地址，通过在前端上写一个方法进行跳转，如下所示。
 它会先跳转到/miaosha/path，获取秒杀地址中的path值，将其存储在Redis中 然后携带path值去访问真正的秒杀方法，在其中将path值与Redis中的值进行比较，一致才能继续秒杀   1.2 获取路径的Java代码 @ResponseBody @RequestMapping(value = &amp;#34;/path&amp;#34;,method = RequestMethod.GET) public Result&amp;lt;String&amp;gt; getMiaoshaPath(MiaoShaUser user,@RequestParam(&amp;#34;goodsId&amp;#34;)long goodsId, @RequestParam(value = &amp;#34;verifyCode&amp;#34;,defaultValue = &amp;#34;0&amp;#34;)int verifyCode){ if(user == null) return Result.error(CodeMsg.SESSION_ERROR); String path = miaoshaService.createMiaoshaPath(user,goodsId); return Result.success(path); } 123456789101112  先调用createMiaoshaPath()方法，在其中会创建一串随机值，并且存储到Redis中，具体方法如下，执行完之后将路径值返回到前端  public String createMiaoshaPath(MiaoShaUser user, long goodsId) { if(user == null || goodsId &amp;lt;= 0) return null; String str = MD5Util.md5(UUIDUtil.getUUID()); redisService.set(MiaoshaKey.miaoshaPathPrefix,user.getId() &#43; &amp;#34;_&amp;#34; &#43; goodsId,str); return str; } 123456789 1." />
<meta name="twitter:site" content="https://kayleh.top" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kayleh.top">


<meta property="og:type" content="article" />
<meta property="og:title" content="Java高性能高并发秒杀系统(9) - Kayleh">
<meta property="og:description"
  content="1. 动态秒杀地址 1.1 前端的改变 之前我们实现秒杀的时候是直接跳转到秒杀接口，使得我们每次的秒杀地址都是一样的，这样具有安全隐患，所以，我们将其改为动态地址，通过在前端上写一个方法进行跳转，如下所示。
 它会先跳转到/miaosha/path，获取秒杀地址中的path值，将其存储在Redis中 然后携带path值去访问真正的秒杀方法，在其中将path值与Redis中的值进行比较，一致才能继续秒杀   1.2 获取路径的Java代码 @ResponseBody @RequestMapping(value = &amp;#34;/path&amp;#34;,method = RequestMethod.GET) public Result&amp;lt;String&amp;gt; getMiaoshaPath(MiaoShaUser user,@RequestParam(&amp;#34;goodsId&amp;#34;)long goodsId, @RequestParam(value = &amp;#34;verifyCode&amp;#34;,defaultValue = &amp;#34;0&amp;#34;)int verifyCode){ if(user == null) return Result.error(CodeMsg.SESSION_ERROR); String path = miaoshaService.createMiaoshaPath(user,goodsId); return Result.success(path); } 123456789101112  先调用createMiaoshaPath()方法，在其中会创建一串随机值，并且存储到Redis中，具体方法如下，执行完之后将路径值返回到前端  public String createMiaoshaPath(MiaoShaUser user, long goodsId) { if(user == null || goodsId &amp;lt;= 0) return null; String str = MD5Util.md5(UUIDUtil.getUUID()); redisService.set(MiaoshaKey.miaoshaPathPrefix,user.getId() &#43; &amp;#34;_&amp;#34; &#43; goodsId,str); return str; } 123456789 1." />
<meta property="og:url" content="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-8/" />
<meta property="og:site_name" content="Java高性能高并发秒杀系统(9)" />
<meta property="og:image"
  content="https://kayleh.top">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-11-09 20:14:45 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kayleh.top">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kayleh.top">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kayleh.top">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kayleh.top">
                  <img class=" avatar-user"
                    src="http://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kayleh.top">Kayleh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-8/">Java高性能高并发秒杀系统(9)</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Mon, 09 Nov 2020 20:14:45 &#43;0800"
                    class="no-wrap">
                    Mon, 09 Nov 2020 20:14:45 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    1483 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/project">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      project
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><h2 id="1-动态秒杀地址">1. 动态秒杀地址</h2>
<h3 id="11-前端的改变">1.1 前端的改变</h3>
<p>之前我们实现秒杀的时候是直接跳转到秒杀接口，使得我们每次的秒杀地址都是一样的，这样具有安全隐患，所以，我们将其改为动态地址，通过在前端上写一个方法进行跳转，如下所示。</p>
<ul>
<li>它会先跳转到<code>/miaosha/path</code>，获取秒杀地址中的<code>path值</code>，将其存储在Redis中<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717200220865.png" alt="在这里插入图片描述"></li>
<li>然后携带<code>path值</code>去访问真正的秒杀方法，在其中将<code>path</code>值与Redis中的值进行比较，一致才能继续秒杀
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717200701223.png" alt="在这里插入图片描述"></li>
</ul>
<h3 id="12-获取路径的java代码">1.2 获取路径的Java代码</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@ResponseBody</span>
    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/path&#34;</span><span style="color:#f92672">,</span>method <span style="color:#f92672">=</span> RequestMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">GET</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> Result<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getMiaoshaPath</span><span style="color:#f92672">(</span>MiaoShaUser user<span style="color:#f92672">,</span><span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;goodsId&#34;</span><span style="color:#f92672">)</span><span style="color:#66d9ef">long</span> goodsId<span style="color:#f92672">,</span>
                                         <span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;verifyCode&#34;</span><span style="color:#f92672">,</span>defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span><span style="color:#f92672">)</span><span style="color:#66d9ef">int</span> verifyCode<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">SESSION_ERROR</span><span style="color:#f92672">);</span>


        String path <span style="color:#f92672">=</span> miaoshaService<span style="color:#f92672">.</span><span style="color:#a6e22e">createMiaoshaPath</span><span style="color:#f92672">(</span>user<span style="color:#f92672">,</span>goodsId<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">success</span><span style="color:#f92672">(</span>path<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
123456789101112
</code></pre></div><ul>
<li>先调用createMiaoshaPath()方法，在其中会创建一串随机值，并且存储到Redis中，具体方法如下，执行完之后将路径值返回到前端</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">createMiaoshaPath</span><span style="color:#f92672">(</span>MiaoShaUser user<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> goodsId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> goodsId <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        String str <span style="color:#f92672">=</span> MD5Util<span style="color:#f92672">.</span><span style="color:#a6e22e">md5</span><span style="color:#f92672">(</span>UUIDUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getUUID</span><span style="color:#f92672">());</span>
        redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>MiaoshaKey<span style="color:#f92672">.</span><span style="color:#a6e22e">miaoshaPathPrefix</span><span style="color:#f92672">,</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> goodsId<span style="color:#f92672">,</span>str<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">return</span> str<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
123456789
</code></pre></div><h3 id="13-执行秒杀接口的修改">1.3 执行秒杀接口的修改</h3>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717212754253.png" alt="在这里插入图片描述"></p>
<ul>
<li>路径上，我们采用了RestFul风格，通过@PathVariable注解获取其中的路径值，并与redis服务器中的值进行比较，一致才能向下一步继续执行</li>
</ul>
<hr>
<h2 id="2-添加验证码验证">2. 添加验证码验证</h2>
<p>我们在立即秒杀按钮处添加验证码，<code>防止机器人对我们的系统进行多次秒杀</code>，也可以使秒杀能够<code>错峰访问</code>，削减并发量，我们采用的是<code>ScriptEngine</code></p>
<h3 id="21-实现过程">2.1 实现过程</h3>
<ol>
<li>首先，我们在路径获取中，添加了对验证码验证的步骤
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717213516271.png" alt="在这里插入图片描述">
在该方法中，实现的是将从前端获取的验证码与Redis存储的验证码进行验证，验证完成之后，就将它从Redis中移除，方法代码如下
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717214223598.png" alt="在这里插入图片描述"></li>
<li>在此之前，前端验证码会和后端有一个响应，每次刷新验证码都会将其的正确结果同步到服务器的Redis上
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717214411513.png" alt="在这里插入图片描述"></li>
</ol>
<hr>
<h2 id="3-接口限流防刷">3. 接口限流防刷</h2>
<ul>
<li>接口限流防刷的作用是在规定的时间内访问固定的次数。我们实现的思路是，在要限制防刷的方法上添加注解，通过拦截器进行限制访问次数</li>
</ul>
<h3 id="31-创建出这个注解">3.1 创建出这个注解</h3>
<p>该注解中，包含了需要访问时间内的访问次数，以及判断是否需要登录</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Retention</span><span style="color:#f92672">(</span>RetentionPolicy<span style="color:#f92672">.</span><span style="color:#a6e22e">RUNTIME</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Target</span><span style="color:#f92672">(</span>ElementType<span style="color:#f92672">.</span><span style="color:#a6e22e">METHOD</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">@interface</span> AccessLimit <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">seconds</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">maxCount</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">needLogin</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
1234567
</code></pre></div><ul>
<li><code>@Retention(RetentionPolicy.RUNTIME)</code>：注解不仅被保存到class文件中，jvm加载class文件之后，仍然存在；</li>
<li><code>@Target(ElementType.METHOD)</code>：表示注解修饰的是方法</li>
</ul>
<p>对我们想要限流的方法进行标记
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/2020071813164559.png" alt="在这里插入图片描述"></p>
<h3 id="32-创建拦截器">3.2 创建拦截器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AccessInterceptor</span> <span style="color:#66d9ef">extends</span> HandlerInterceptorAdapter <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    MiaoShaUserService userService<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@Autowired</span>
    RedisService redisService<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">preHandle</span><span style="color:#f92672">(</span>HttpServletRequest request<span style="color:#f92672">,</span> HttpServletResponse response<span style="color:#f92672">,</span> Object handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>

        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>handler <span style="color:#66d9ef">instanceof</span> HandlerMethod<span style="color:#f92672">){</span>
            MiaoShaUser user  <span style="color:#f92672">=</span> getUser<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span>response<span style="color:#f92672">);</span>
            UserContext<span style="color:#f92672">.</span><span style="color:#a6e22e">setUser</span><span style="color:#f92672">(</span>user<span style="color:#f92672">);</span>
            HandlerMethod hm <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HandlerMethod<span style="color:#f92672">)</span> handler<span style="color:#f92672">;</span>
            <span style="color:#75715e">//处理方法的对象，获取的是方法的注解
</span><span style="color:#75715e"></span>            AccessLimit accessLimit <span style="color:#f92672">=</span> hm<span style="color:#f92672">.</span><span style="color:#a6e22e">getMethodAnnotation</span><span style="color:#f92672">(</span>AccessLimit<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>accessLimit <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">int</span> seconds <span style="color:#f92672">=</span> accessLimit<span style="color:#f92672">.</span><span style="color:#a6e22e">seconds</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">int</span> maxCount <span style="color:#f92672">=</span> accessLimit<span style="color:#f92672">.</span><span style="color:#a6e22e">maxCount</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">boolean</span> needLogin <span style="color:#f92672">=</span> accessLimit<span style="color:#f92672">.</span><span style="color:#a6e22e">needLogin</span><span style="color:#f92672">();</span>
            String key <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestURI</span><span style="color:#f92672">();</span><span style="color:#75715e">//获取请求的地址
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>needLogin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
                    <span style="color:#75715e">//user为空，递交错误信息
</span><span style="color:#75715e"></span>                    render<span style="color:#f92672">(</span>response<span style="color:#f92672">,</span> CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">SESSION_ERROR</span><span style="color:#f92672">);</span>
                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
                <span style="color:#f92672">}</span>
                key <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#34;_&#34;</span> <span style="color:#f92672">+</span> user<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            AccessKey accessKey <span style="color:#f92672">=</span> AccessKey<span style="color:#f92672">.</span><span style="color:#a6e22e">withExpireSecond</span><span style="color:#f92672">(</span>seconds<span style="color:#f92672">);</span>
            Integer count <span style="color:#f92672">=</span> redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>accessKey<span style="color:#f92672">,</span> key<span style="color:#f92672">,</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>count <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
                redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>accessKey<span style="color:#f92672">,</span>key<span style="color:#f92672">,</span>1<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> maxCount<span style="color:#f92672">){</span>
                redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">incr</span><span style="color:#f92672">(</span>accessKey<span style="color:#f92672">,</span>key<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
                render<span style="color:#f92672">(</span>response<span style="color:#f92672">,</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">ACCESS_LIMIT_REACHED</span><span style="color:#f92672">);</span>
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
	<span style="color:#f92672">......</span>
<span style="color:#f92672">}</span>
12345678910111213141516171819202122232425262728293031323334353637383940414243444546
</code></pre></div><ul>
<li>继承<code>HandlerInterceptorAdapter</code>，重写<code>preHandle</code>方法</li>
<li>重要的UserContext
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200718134859274.png" alt="在这里插入图片描述">
我们看一下具体的实现</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserContext</span> <span style="color:#f92672">{</span>

    <span style="color:#75715e">//用ThreadLocal来装user信息，调用它的set和get方法，向其中存储值
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//ThreadLocal是为当前线程存储值，所以，在多线程下，各个线程的user并不冲突
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ThreadLocal<span style="color:#f92672">&lt;</span>MiaoShaUser<span style="color:#f92672">&gt;</span> userHolder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">&lt;&gt;();</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setUser</span><span style="color:#f92672">(</span>MiaoShaUser user<span style="color:#f92672">){</span>
        userHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>user<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> MiaoShaUser <span style="color:#a6e22e">getUser</span><span style="color:#f92672">(){</span>
        <span style="color:#66d9ef">return</span> userHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
1234567891011121314
</code></pre></div><p>其中ThreadLocal()源码如下
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200718135610756.png" alt="在这里插入图片描述"></p>
<h3 id="33-后序步骤解释">3.3 后序步骤解释</h3>
<p><strong>方法后边比较简单啦</strong>
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200718144817668.png" alt="在这里插入图片描述"></p>
<h3 id="34-切莫忘记配置不配置约等于不加拦截器">3.4 切莫忘记配置，不配置约等于不加拦截器</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Configuration</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebConfig</span> <span style="color:#66d9ef">extends</span> WebMvcConfigurerAdapter<span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Autowired</span>
    UserArgumentResolver userArgumentResolver<span style="color:#f92672">;</span>
    <span style="color:#a6e22e">@Autowired</span>
    AccessInterceptor accessInterceptor<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addArgumentResolvers</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>HandlerMethodArgumentResolver<span style="color:#f92672">&gt;</span> argumentResolvers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">addArgumentResolvers</span><span style="color:#f92672">(</span>argumentResolvers<span style="color:#f92672">);</span>
        argumentResolvers<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>userArgumentResolver<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addInterceptors</span><span style="color:#f92672">(</span>InterceptorRegistry registry<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        InterceptorRegistration interceptorRegistration <span style="color:#f92672">=</span> registry<span style="color:#f92672">.</span><span style="color:#a6e22e">addInterceptor</span><span style="color:#f92672">(</span>accessInterceptor<span style="color:#f92672">);</span>
        interceptorRegistration<span style="color:#f92672">.</span><span style="color:#a6e22e">addPathPatterns</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/miaosha/path&#34;</span><span style="color:#f92672">);</span>

    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
123456789101112131415161718192021
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200718144110839.png" alt="在这里插入图片描述"></p>
<p>在这个配置类中，我们重写的是addInterceptors方法，将拦截器注入进来，加到配置中，(指定要拦截的地址这一步可以省略掉了，因为我们使用的是注解标记，前边有一处写错，开始写的是没有注解的话，返回false，这样全局都被拦截了，应该写成true，这样才能放行），接下来就可以使用了！</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kayleh.top">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://kayleh.top/js/github-style.js"></script>



</html>