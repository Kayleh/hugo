<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kayleh.top/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kayleh.top/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github-style.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/light.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/dark.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/syntax.css' />
    <title>SpringCloud Stream消息驱动 - Kayleh</title>
    
    <link rel="icon" type="image/x-icon" href='https://kayleh.top/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="SpringCloud Stream消息驱动
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kayleh.top/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="SpringCloud Stream消息驱动 - Kayleh" />
<meta name="twitter:description"
  content="SpringCloud Stream消息驱动
" />
<meta name="twitter:site" content="https://kayleh.top" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kayleh.top">


<meta property="og:type" content="article" />
<meta property="og:title" content="SpringCloud Stream消息驱动 - Kayleh">
<meta property="og:description"
  content="SpringCloud Stream消息驱动
" />
<meta property="og:url" content="https://kayleh.top/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/" />
<meta property="og:site_name" content="SpringCloud Stream消息驱动" />
<meta property="og:image"
  content="https://kayleh.top">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-08-14 23:33:07 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kayleh.top">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kayleh.top">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kayleh.top">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kayleh.top">
                  <img class=" avatar-user"
                    src="http://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kayleh.top">Kayleh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://kayleh.top/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/">SpringCloud Stream消息驱动</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Fri, 14 Aug 2020 23:33:07 &#43;0800"
                    class="no-wrap">
                    Fri, 14 Aug 2020 23:33:07 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    2805 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/distributedmicroservices">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      DistributedMicroservices
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>SpringCloud Stream消息驱动</p>
<h1 id="消息驱动概述">消息驱动概述</h1>
<p>屏蔽底层消息中间件的差异，降低切换版本，统一消息的编程模型</p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/1.png" alt="1597388512890"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/2.png" alt="1597388531508"></p>
<p>Spring Cloud Stream中文指导手册</p>
<p><a href="https://m.wang1314.com/doc/webapp/topic/20971999.html">https://m.wang1314.com/doc/webapp/topic/20971999.html</a></p>
<h3 id="设计思想">设计思想</h3>
<h5 id="标准mq">标准MQ</h5>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/3.png" alt="1597828873174"></p>
<blockquote>
<p>生产者/消费者之间靠消息媒介传递信息内容:\</p>
<p><code>Message</code></p>
<p>消息必须走特定的通道</p>
<p><code>消息通道MessageChannel</code></p>
<p>消息通道里的消息如何被消费呢，谁负责收发处理:</p>
<p><code>消息通道MessageChannel的子接口SubscribableChannel,由MessageHandler消息处理器订阅</code></p>
</blockquote>
<h5 id="为什么用cloud-stream">为什么用Cloud Stream</h5>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/1598076856767.png" alt="1598076856767"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/4.png" alt="1598076876160"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/1598076887339.png" alt="1598076887339"></p>
<p>stream凭什么可以统一底层差异</p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/5.png" alt="1597828959376"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/6.png" alt="1597828966885"></p>
<p>Binder</p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/8.png" alt="1597828986684"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/7.png" alt="1597828994579"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/9.png" alt="1597829004031"></p>
<blockquote>
<p>INPUT对应于消费者</p>
<p>OUTPUT对应于生产者</p>
</blockquote>
<h5 id="stream中的消息通信方式遵循了发布-订阅模式">Stream中的消息通信方式遵循了发布-订阅模式</h5>
<p>Topic主题进行广播</p>
<blockquote>
<p>在RabbitMQ就是Exchange</p>
<p>在kafka中就是Topic</p>
</blockquote>
<h5 id="spring-cloud-stream标准流程套路">Spring Cloud Stream标准流程套路</h5>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/10.png" alt="1597829077773"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/11.png" alt="1597829087752"></p>
<blockquote>
<p><strong>Binder</strong></p>
<p>很方便的连接中间件，屏蔽差异</p>
<p><strong>Channel</strong></p>
<p>通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过对Channel对队列进行配置</p>
<p><strong>Source和Sink</strong></p>
<p>简单的可理解为参照对象是Spring Cloud Stream自身，从Stream发布消息就是输出，接受消息就是输入</p>
</blockquote>
<h5 id="编码api和常用注解">编码API和常用注解</h5>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/12.png" alt="1597829175675"></p>
<h1 id="案例说明">案例说明</h1>
<p>RabbitMQ环境已经OK</p>
<p>工程中新建三个子模块</p>
<blockquote>
<p>cloud-stream-rabbitmq-provider8801,作为生产者进行发消息模块</p>
<p>cloud-stream-rabbitmq-consumer8802,作为消息接收模块</p>
<p>cloud-stream-rabbitmq-consumer8803,作为消息接收模块</p>
</blockquote>
<h3 id="消息驱动之生产者">消息驱动之生产者</h3>
<p>新建Module</p>
<p>cloud-stream-rabbitmq-provider8801</p>
<p>pom</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">    <span style="color:#f92672">&lt;dependencies&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka-server --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>com.kayleh.springcloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>cloud-api-commons<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>${project.version}<span style="color:#f92672">&lt;/version&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>


        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

     
        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-devtools --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-devtools<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</code></pre></div><p>yaml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">server</span>:
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8801</span>

<span style="color:#f92672">spring</span>:
  <span style="color:#f92672">application</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloud-stream-provider</span>
  <span style="color:#f92672">cloud</span>:
    <span style="color:#f92672">stream</span>:
      <span style="color:#f92672">binders</span>: <span style="color:#75715e"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span style="color:#f92672">defaultRabbit</span>: <span style="color:#75715e"># 表示定义的名称，用于于binding整合</span>
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rabbit # 消息组件类型</span>
          <span style="color:#f92672">environment</span>: <span style="color:#75715e"># 设置rabbitmq的相关的环境配置</span>
            <span style="color:#f92672">spring</span>:
              <span style="color:#f92672">rabbitmq</span>:
                <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
                <span style="color:#f92672">port</span>: <span style="color:#ae81ff">5672</span>
                <span style="color:#f92672">username</span>: <span style="color:#ae81ff">guest</span>
                <span style="color:#f92672">password</span>: <span style="color:#ae81ff">guest</span>
      <span style="color:#f92672">bindings</span>: <span style="color:#75715e"># 服务的整合处理</span>
        <span style="color:#f92672">output</span>: <span style="color:#75715e"># 这个名字是一个通道的名称</span>
          <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">studyExchange # 表示要使用的Exchange名称定义</span>
          <span style="color:#f92672">content-type</span>: <span style="color:#ae81ff">application/json # 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span style="color:#f92672">binder</span>: <span style="color:#ae81ff">defaultRabbit  # 设置要绑定的消息服务的具体设置</span>

<span style="color:#f92672">eureka</span>:
  <span style="color:#f92672">client</span>: <span style="color:#75715e"># 客户端进行Eureka注册的配置</span>
    <span style="color:#f92672">service-url</span>:
      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://localhost:7001/eureka</span>
  <span style="color:#f92672">instance</span>:
    <span style="color:#f92672">lease-renewal-interval-in-seconds</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 设置心跳的时间间隔（默认是30秒）</span>
    <span style="color:#f92672">lease-expiration-duration-in-seconds</span>: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 如果现在超过了5秒的间隔（默认是90秒）</span>
    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">send-8801.com  # 在信息列表时显示主机名称</span>
    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># 访问的路径变为IP地址</span>
</code></pre></div><p>主启动类StreamMQMain8801</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@SpringBootApplication</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StreamMQMain8801</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>StreamMQMain8801<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h5 id="业务类">业务类</h5>
<p>发送消息接口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud.service<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IMessageProvider</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">send</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>发送消息接口实现类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud.service.impl<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@EnableBinding</span><span style="color:#f92672">(</span>Source<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#75715e">//定义消息的推送管道
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageProviderImpl</span> <span style="color:#66d9ef">implements</span> IMessageProvider
<span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Resource</span>
    <span style="color:#66d9ef">private</span> MessageChannel output<span style="color:#f92672">;</span> <span style="color:#75715e">// 消息发送管道
</span><span style="color:#75715e"></span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">send</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">{</span>
        String serial <span style="color:#f92672">=</span> UUID<span style="color:#f92672">.</span><span style="color:#a6e22e">randomUUID</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
        output<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>MessageBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">withPayload</span><span style="color:#f92672">(</span>serial<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*****serial: &#34;</span><span style="color:#f92672">+</span>serial<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Controller</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud.controller<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> com.kayleh.springcloud.service.IMessageProvider<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.GetMapping<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RestController<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> javax.annotation.Resource<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@RestController</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SendMessageController</span>
<span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Resource</span>
    <span style="color:#66d9ef">private</span> IMessageProvider messageProvider<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/sendMessage&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">()</span>
    <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> messageProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>测试</p>
<p>启动7001eureka</p>
<p>启动rabbitmq:</p>
<blockquote>
<p>rabbitmq-plugins enable rabbitmq_management</p>
<p>http://localhost:15672/</p>
</blockquote>
<p>启动8801</p>
<p>访问http://localhost:8801/sendMessage</p>
<h3 id="消息驱动之消费者">消息驱动之消费者</h3>
<p>新建Module</p>
<p>cloud-stream-rabbitmq-consumer8802</p>
<p>pom</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">    <span style="color:#f92672">&lt;dependencies&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka-server --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>com.kayleh.springcloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>cloud-api-commons<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;version&gt;</span>${project.version}<span style="color:#f92672">&lt;/version&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>


        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>


        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-devtools --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-devtools<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>

        <span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test --&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</code></pre></div><p>yml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">server</span>:
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8802</span>

<span style="color:#f92672">spring</span>:
  <span style="color:#f92672">application</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloud-stream-consumer</span>
  <span style="color:#f92672">cloud</span>:
    <span style="color:#f92672">stream</span>:
      <span style="color:#f92672">binders</span>: <span style="color:#75715e"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span style="color:#f92672">defaultRabbit</span>: <span style="color:#75715e"># 表示定义的名称，用于于binding整合</span>
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rabbit # 消息组件类型</span>
          <span style="color:#f92672">environment</span>: <span style="color:#75715e"># 设置rabbitmq的相关的环境配置</span>
            <span style="color:#f92672">spring</span>:
              <span style="color:#f92672">rabbitmq</span>:
                <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
                <span style="color:#f92672">port</span>: <span style="color:#ae81ff">5672</span>
                <span style="color:#f92672">username</span>: <span style="color:#ae81ff">guest</span>
                <span style="color:#f92672">password</span>: <span style="color:#ae81ff">guest</span>
      <span style="color:#f92672">bindings</span>: <span style="color:#75715e"># 服务的整合处理</span>
        <span style="color:#f92672">input</span>: <span style="color:#75715e"># 这个名字是一个通道的名称</span>
          <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">studyExchange # 表示要使用的Exchange名称定义</span>
          <span style="color:#f92672">content-type</span>: <span style="color:#ae81ff">application/json # 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span style="color:#f92672">binder</span>: <span style="color:#ae81ff">defaultRabbit  # 设置要绑定的消息服务的具体设置</span>

<span style="color:#f92672">eureka</span>:
  <span style="color:#f92672">client</span>: <span style="color:#75715e"># 客户端进行Eureka注册的配置</span>
    <span style="color:#f92672">service-url</span>:
      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://localhost:7001/eureka</span>
  <span style="color:#f92672">instance</span>:
    <span style="color:#f92672">lease-renewal-interval-in-seconds</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 设置心跳的时间间隔（默认是30秒）</span>
    <span style="color:#f92672">lease-expiration-duration-in-seconds</span>: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 如果现在超过了5秒的间隔（默认是90秒）</span>
    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">receive-8802.com  # 在信息列表时显示主机名称</span>
    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># 访问的路径变为IP地址</span>
</code></pre></div><p>主启动类StreamMQMain8802</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@SpringBootApplication</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StreamMQMain8802</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>StreamMQMain8802<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>controller</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud.controller<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.cloud.stream.annotation.StreamListener<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.messaging.Message<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Value<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.cloud.stream.annotation.EnableBinding<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.cloud.stream.messaging.Sink<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.stereotype.Component<span style="color:#f92672">;</span>

<span style="color:#a6e22e">@Component</span>
<span style="color:#a6e22e">@EnableBinding</span><span style="color:#f92672">(</span>Sink<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReceiveMessageListenerController</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${server.port}&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> String serverPort<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@StreamListener</span><span style="color:#f92672">(</span>Sink<span style="color:#f92672">.</span><span style="color:#a6e22e">INPUT</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">input</span><span style="color:#f92672">(</span>Message<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消费者1号，接受：&#34;</span><span style="color:#f92672">+</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getPayload</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;\t port:&#34;</span><span style="color:#f92672">+</span>serverPort<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>测试8801发送8802接收消息</p>
<blockquote>
<p>http://localhost:8801/sendMessage</p>
</blockquote>
<h3 id="分组消费与持久化">分组消费与持久化</h3>
<h5 id="依照8802clone出来一份运行8803">依照8802，clone出来一份运行8803</h5>
<p>cloud-stream-rabbitmq-consumer8803</p>
<p>pom</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"> <span style="color:#f92672">&lt;dependencies&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#75715e">&lt;!--基础配置--&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-devtools<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
        <span style="color:#f92672">&lt;dependency&gt;</span>
            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
            <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
        <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;/dependencies&gt;</span>

</code></pre></div><p>yaml</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">server</span>:
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8803</span>

<span style="color:#f92672">spring</span>:
  <span style="color:#f92672">application</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloud-stream-consumer</span>
  <span style="color:#f92672">cloud</span>:
      <span style="color:#f92672">stream</span>:
        <span style="color:#f92672">binders</span>: <span style="color:#75715e"># 在此处配置要绑定的rabbitmq的服务信息；</span>
          <span style="color:#f92672">defaultRabbit</span>: <span style="color:#75715e"># 表示定义的名称，用于于binding整合</span>
            <span style="color:#f92672">type</span>: <span style="color:#ae81ff">rabbit # 消息组件类型</span>
            <span style="color:#f92672">environment</span>: <span style="color:#75715e"># 设置rabbitmq的相关的环境配置</span>
              <span style="color:#f92672">spring</span>:
                <span style="color:#f92672">rabbitmq</span>:
                  <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
                  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">5672</span>
                  <span style="color:#f92672">username</span>: <span style="color:#ae81ff">guest</span>
                  <span style="color:#f92672">password</span>: <span style="color:#ae81ff">guest</span>
        <span style="color:#f92672">bindings</span>: <span style="color:#75715e"># 服务的整合处理</span>
          <span style="color:#f92672">input</span>: <span style="color:#75715e"># 这个名字是一个通道的名称</span>
            <span style="color:#f92672">destination</span>: <span style="color:#ae81ff">studyExchange # 表示要使用的Exchange名称定义</span>
            <span style="color:#f92672">content-type</span>: <span style="color:#ae81ff">application/json # 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span>
            <span style="color:#f92672">binder</span>: <span style="color:#ae81ff">defaultRabbit # 设置要绑定的消息服务的具体设置</span>
            <span style="color:#f92672">group</span>: <span style="color:#ae81ff">kaylehA</span>

<span style="color:#f92672">eureka</span>:
  <span style="color:#f92672">client</span>: <span style="color:#75715e"># 客户端进行Eureka注册的配置</span>
    <span style="color:#f92672">service-url</span>:
      <span style="color:#f92672">defaultZone</span>: <span style="color:#ae81ff">http://localhost:7001/eureka</span>
  <span style="color:#f92672">instance</span>:
    <span style="color:#f92672">lease-renewal-interval-in-seconds</span>: <span style="color:#ae81ff">2</span> <span style="color:#75715e"># 设置心跳的时间间隔（默认是30秒）</span>
    <span style="color:#f92672">lease-expiration-duration-in-seconds</span>: <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 如果现在超过了5秒的间隔（默认是90秒）</span>
    <span style="color:#f92672">instance-id</span>: <span style="color:#ae81ff">receive-8803.com  # 在信息列表时显示主机名称</span>
    <span style="color:#f92672">prefer-ip-address</span>: <span style="color:#66d9ef">true</span>     <span style="color:#75715e"># 访问的路径变为IP地址</span>
</code></pre></div><p>主启动类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.boot.SpringApplication<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.SpringBootApplication<span style="color:#f92672">;</span>


<span style="color:#a6e22e">@SpringBootApplication</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StreamMQMain8803</span>
<span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span>
    <span style="color:#f92672">{</span>
        SpringApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">(</span>StreamMQMain8803<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>args<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>业务类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> com.kayleh.springcloud.controller<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> org.springframework.beans.factory.annotation.Value<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.cloud.stream.annotation.EnableBinding<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.cloud.stream.annotation.StreamListener<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.cloud.stream.messaging.Sink<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.messaging.Message<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.springframework.stereotype.Component<span style="color:#f92672">;</span>
 
<span style="color:#a6e22e">@Component</span>
<span style="color:#a6e22e">@EnableBinding</span><span style="color:#f92672">(</span>Sink<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReceiveMessageListenerController</span>
<span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Value</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;${server.port}&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">private</span> String serverPort<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@StreamListener</span><span style="color:#f92672">(</span>Sink<span style="color:#f92672">.</span><span style="color:#a6e22e">INPUT</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">input</span><span style="color:#f92672">(</span>Message<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> message<span style="color:#f92672">)</span>
    <span style="color:#f92672">{</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;消费者2号,-----&gt;接受到的消息: &#34;</span><span style="color:#f92672">+</span>message<span style="color:#f92672">.</span><span style="color:#a6e22e">getPayload</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;\t  port: &#34;</span><span style="color:#f92672">+</span>serverPort<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>启动</p>
<blockquote>
<p>7001服务注册</p>
<p>8801消息生产</p>
<p>8802消息消费</p>
<p>8803消息消费</p>
</blockquote>
<p>运行后两个问题</p>
<blockquote>
<p>有重复消费问题</p>
<p>消息持久化问题</p>
</blockquote>
<p>消费</p>
<blockquote>
<p>目前是8802/8803同时都收到了，存在重复消费问题</p>
<p>http://localhost:8801/sendMessage</p>
<p>如何解决?</p>
<p>分组和持久化属性group</p>
<p>重要</p>
<p>生产实际案例</p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/13.png" alt="1597830160806"></p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/14.png" alt="1597830172304"></p>
</blockquote>
<h5 id="分组">分组</h5>
<ul>
<li>
<p>原理</p>
<blockquote>
<p>微服务应用放置于</p>
<p>同一个group中，就能够保证消息只会被其中一个应用消费一次。</p>
<p>不同的组是可以消费的，同一个组内会发生竞争关系，只有其中一个可以消费。</p>
</blockquote>
</li>
<li>
<p>8802/8803都变成不同组，group两个不同</p>
<blockquote>
<p>group: kaylehA、kaylehB</p>
<p>8802修改YML</p>
<p>在binder下面添加</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">group</span>:  <span style="color:#ae81ff">kaylehA</span>
</code></pre></div><p>8803修改YML</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">group</span>:  <span style="color:#ae81ff">kaylehB</span>
</code></pre></div><p>我们自己配置</p>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn/img/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%847/15.png" alt="1597830340659"></p>
<p>结论</p>
<p>还是重复消费</p>
</blockquote>
</li>
<li>
<p>8802/8803实现了轮询分组，每次只有一个消费者 8801模块的发的消息只能被8802或8803其中一个接收到，这样避免了重复消费</p>
</li>
<li>
<p>8802/8803都变成相同组，group两个相同</p>
<blockquote>
<p>group: kaylehA</p>
<p>8802修改YML</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">group</span>:  <span style="color:#ae81ff">kaylehA</span>
</code></pre></div><p>8803修改YML</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">group</span>:  <span style="color:#ae81ff">kaylehA</span>
</code></pre></div><p>结论</p>
<p>同一个组的多个微服务实例，每次只会有一个拿到</p>
</blockquote>
</li>
</ul>
<h5 id="持久化">持久化</h5>
<p>通过上述，解决了重复消费问题，再看看持久化</p>
<p>停止8802/8803并去除掉8802的分组group:kaylehA</p>
<p>8803的分组group:kaylehA没有去掉</p>
<p>8801先发送4条信息到rabbitmq</p>
<p>先启动8802，无分组属性配置，后台没有打出来消息</p>
<p>先启动8803，有分组属性配置，后台打出来了MQ上的消息</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kayleh.top">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://kayleh.top/js/github-style.js"></script>



</html>