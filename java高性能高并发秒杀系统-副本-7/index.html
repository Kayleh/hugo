<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kayleh.top/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kayleh.top/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github-style.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/light.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/dark.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/syntax.css' />
    <title>Java高性能高并发秒杀系统(8) - Kayleh</title>
    
    <link rel="icon" type="image/x-icon" href='https://kayleh.top/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="1. 秒杀接口优化思路  重点我们是要减少对数据库的访问
  系统初始化时，将秒杀商品库存加载到Redis中 收到请求，在Redis中预减库存，库存不足时，直接返回秒杀失败 秒杀成功，将订单压入消息队列，返回前端消息“排队中”（像12306的买票） 消息出队，生成订单，减少库存 客户端在以上过程执行过程中，将一直轮询是否秒杀成功   2. 清晰框图解析  3. 代码中我们如何实现 3.1 库存预加载到Redis中 这里我们是通过实现InitialzingBean接口，重写其中afterProperties方法达成的
public class MiaoshaController implements InitializingBean { @Override public void afterPropertiesSet() throws Exception { //系统启动的时候，就将数据存入Redis  //加载所有秒杀商品  List&amp;lt;GoodsVo&amp;gt; goodsVos = goodsService.listGoodsVo(); if(goodsVos == null) return; //存入Redis中，各秒杀商品的数量  for (GoodsVo good : goodsVos){ redisService.set(GoodsKey.miaoshaGoodsStockPrefix,&amp;#34;&amp;#34;&#43;good.getId(),good.getStockCount()); map.put(good.getId(),false); } } ...... } 12345678910111213141516171819  我们先从数据库中将秒杀商品的信息读取出来，再一个一个加载到缓存中 注意一下其中有一个map，它添加了对应Id-false的键值对，它表示的是该商品没有被秒杀完，用于下文中，当商品秒杀完，阻止其对redis服务的访问（后文还会提到）  3.2 开始秒杀，预减库存 //user不能为空，空了去登陆  if(user == null){ return Result." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-7/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Java高性能高并发秒杀系统(8) - Kayleh" />
<meta name="twitter:description"
  content="1. 秒杀接口优化思路  重点我们是要减少对数据库的访问
  系统初始化时，将秒杀商品库存加载到Redis中 收到请求，在Redis中预减库存，库存不足时，直接返回秒杀失败 秒杀成功，将订单压入消息队列，返回前端消息“排队中”（像12306的买票） 消息出队，生成订单，减少库存 客户端在以上过程执行过程中，将一直轮询是否秒杀成功   2. 清晰框图解析  3. 代码中我们如何实现 3.1 库存预加载到Redis中 这里我们是通过实现InitialzingBean接口，重写其中afterProperties方法达成的
public class MiaoshaController implements InitializingBean { @Override public void afterPropertiesSet() throws Exception { //系统启动的时候，就将数据存入Redis  //加载所有秒杀商品  List&amp;lt;GoodsVo&amp;gt; goodsVos = goodsService.listGoodsVo(); if(goodsVos == null) return; //存入Redis中，各秒杀商品的数量  for (GoodsVo good : goodsVos){ redisService.set(GoodsKey.miaoshaGoodsStockPrefix,&amp;#34;&amp;#34;&#43;good.getId(),good.getStockCount()); map.put(good.getId(),false); } } ...... } 12345678910111213141516171819  我们先从数据库中将秒杀商品的信息读取出来，再一个一个加载到缓存中 注意一下其中有一个map，它添加了对应Id-false的键值对，它表示的是该商品没有被秒杀完，用于下文中，当商品秒杀完，阻止其对redis服务的访问（后文还会提到）  3.2 开始秒杀，预减库存 //user不能为空，空了去登陆  if(user == null){ return Result." />
<meta name="twitter:site" content="https://kayleh.top" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kayleh.top">


<meta property="og:type" content="article" />
<meta property="og:title" content="Java高性能高并发秒杀系统(8) - Kayleh">
<meta property="og:description"
  content="1. 秒杀接口优化思路  重点我们是要减少对数据库的访问
  系统初始化时，将秒杀商品库存加载到Redis中 收到请求，在Redis中预减库存，库存不足时，直接返回秒杀失败 秒杀成功，将订单压入消息队列，返回前端消息“排队中”（像12306的买票） 消息出队，生成订单，减少库存 客户端在以上过程执行过程中，将一直轮询是否秒杀成功   2. 清晰框图解析  3. 代码中我们如何实现 3.1 库存预加载到Redis中 这里我们是通过实现InitialzingBean接口，重写其中afterProperties方法达成的
public class MiaoshaController implements InitializingBean { @Override public void afterPropertiesSet() throws Exception { //系统启动的时候，就将数据存入Redis  //加载所有秒杀商品  List&amp;lt;GoodsVo&amp;gt; goodsVos = goodsService.listGoodsVo(); if(goodsVos == null) return; //存入Redis中，各秒杀商品的数量  for (GoodsVo good : goodsVos){ redisService.set(GoodsKey.miaoshaGoodsStockPrefix,&amp;#34;&amp;#34;&#43;good.getId(),good.getStockCount()); map.put(good.getId(),false); } } ...... } 12345678910111213141516171819  我们先从数据库中将秒杀商品的信息读取出来，再一个一个加载到缓存中 注意一下其中有一个map，它添加了对应Id-false的键值对，它表示的是该商品没有被秒杀完，用于下文中，当商品秒杀完，阻止其对redis服务的访问（后文还会提到）  3.2 开始秒杀，预减库存 //user不能为空，空了去登陆  if(user == null){ return Result." />
<meta property="og:url" content="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-7/" />
<meta property="og:site_name" content="Java高性能高并发秒杀系统(8)" />
<meta property="og:image"
  content="https://kayleh.top">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-11-09 20:12:45 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kayleh.top">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kayleh.top">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kayleh.top">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kayleh.top">
                  <img class=" avatar-user"
                    src="http://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kayleh.top">Kayleh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://kayleh.top/java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F-%E5%89%AF%E6%9C%AC-7/">Java高性能高并发秒杀系统(8)</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Mon, 09 Nov 2020 20:12:45 &#43;0800"
                    class="no-wrap">
                    Mon, 09 Nov 2020 20:12:45 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    1477 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/project">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      project
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><h2 id="1-秒杀接口优化思路">1. 秒杀接口优化思路</h2>
<blockquote>
<p>重点我们是要减少对数据库的访问</p>
</blockquote>
<ol>
<li>系统初始化时，将秒杀商品库存加载到Redis中</li>
<li>收到请求，在Redis中预减库存，库存不足时，直接返回秒杀失败</li>
<li>秒杀成功，将订单压入消息队列，返回前端消息“排队中”（像12306的买票）</li>
<li>消息出队，生成订单，减少库存</li>
<li>客户端在以上过程执行过程中，将一直轮询是否秒杀成功</li>
</ol>
<hr>
<h2 id="2-清晰框图解析">2. 清晰框图解析</h2>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/Java%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%B9%B6%E5%8F%91%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/20200717154409401.png" alt="在这里插入图片描述"></p>
<hr>
<h2 id="3-代码中我们如何实现">3. 代码中我们如何实现</h2>
<h3 id="31-库存预加载到redis中">3.1 库存预加载到Redis中</h3>
<p>这里我们是通过实现<code>InitialzingBean接口</code>，重写其中<code>afterProperties方法</code>达成的</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MiaoshaController</span> <span style="color:#66d9ef">implements</span> InitializingBean <span style="color:#f92672">{</span>
	    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterPropertiesSet</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#75715e">//系统启动的时候，就将数据存入Redis
</span><span style="color:#75715e"></span>
        <span style="color:#75715e">//加载所有秒杀商品
</span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>GoodsVo<span style="color:#f92672">&gt;</span> goodsVos <span style="color:#f92672">=</span> goodsService<span style="color:#f92672">.</span><span style="color:#a6e22e">listGoodsVo</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>goodsVos <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
        <span style="color:#75715e">//存入Redis中，各秒杀商品的数量
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>GoodsVo good <span style="color:#f92672">:</span> goodsVos<span style="color:#f92672">){</span>
            redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>GoodsKey<span style="color:#f92672">.</span><span style="color:#a6e22e">miaoshaGoodsStockPrefix</span><span style="color:#f92672">,</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">+</span>good<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span>good<span style="color:#f92672">.</span><span style="color:#a6e22e">getStockCount</span><span style="color:#f92672">());</span>
            map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>good<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

    <span style="color:#f92672">}</span>

	<span style="color:#f92672">......</span>
<span style="color:#f92672">}</span>
12345678910111213141516171819
</code></pre></div><ol>
<li>我们先从数据库中将秒杀商品的信息读取出来，再一个一个加载到缓存中</li>
<li>注意一下其中有一个map，它添加了对应Id-false的键值对，它表示的是该商品没有被秒杀完，用于下文中，当商品秒杀完，阻止其对redis服务的访问（后文还会提到）</li>
</ol>
<h3 id="32-开始秒杀预减库存">3.2 开始秒杀，预减库存</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">        <span style="color:#75715e">//user不能为空，空了去登陆
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">SESSION_ERROR</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#75715e">//HashMap内存标记，减少Redis访问时间
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> over <span style="color:#f92672">=</span> map<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>goodsId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>over<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">MIAO_SHA_OVER</span><span style="color:#f92672">);</span>

        <span style="color:#75715e">//收到请求，预减库存
</span><span style="color:#75715e"></span>        Long count <span style="color:#f92672">=</span> redisService<span style="color:#f92672">.</span><span style="color:#a6e22e">decr</span><span style="color:#f92672">(</span>GoodsKey<span style="color:#f92672">.</span><span style="color:#a6e22e">miaoshaGoodsStockPrefix</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> goodsId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;=</span> 0<span style="color:#f92672">){</span>
            map<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>goodsId<span style="color:#f92672">,</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">MIAO_SHA_OVER</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
12345678910111213141516
</code></pre></div><ol>
<li>首先用户不能为空</li>
<li>这里我们又看见了map，它写在了Redis服务前边，当商品秒杀完毕的时候，这样就能防止它再去访问Redis服务了</li>
<li>预减库存，库存小于0的时候就返回秒杀失败</li>
</ol>
<h3 id="33-加入消息队列中direct-exchange">3.3 加入消息队列中（Direct Exchange）</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">        <span style="color:#75715e">//判断是否已经秒杀过了
</span><span style="color:#75715e"></span>        MiaoshaOrder miaoshaOrder <span style="color:#f92672">=</span> orderService<span style="color:#f92672">.</span><span style="color:#a6e22e">selectMiaoshaOrderByUserIdGoodsId</span><span style="color:#f92672">(</span>user<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span> goodsId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>miaoshaOrder <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">REPEATE_MIAOSHA</span><span style="color:#f92672">);</span>

        <span style="color:#75715e">//加入消息队列
</span><span style="color:#75715e"></span>        MiaoshaMessage miaoshaMessage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MiaoshaMessage<span style="color:#f92672">();</span>
        miaoshaMessage<span style="color:#f92672">.</span><span style="color:#a6e22e">setGoodsId</span><span style="color:#f92672">(</span>goodsId<span style="color:#f92672">);</span>
        miaoshaMessage<span style="color:#f92672">.</span><span style="color:#a6e22e">setMiaoShaUser</span><span style="color:#f92672">(</span>user<span style="color:#f92672">);</span>
        mqSender<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMiaoshaMessage</span><span style="color:#f92672">(</span>miaoshaMessage<span style="color:#f92672">);</span>
12345678910
</code></pre></div><ol>
<li>在其之前我们有一个判断，判断该用户是不是重复秒杀，其实这一步是多余的，因为我们在数据库中已经建立了唯一索引，将userId和GoodsId绑定在了一起，不会生成重复的订单</li>
<li>自定义MiaoshaMessage类，创建对象，其中加入我们想要的user和goodsId信息，并将消息发出去</li>
</ol>
<h3 id="34-消息发送过程">3.4 消息发送过程</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Autowired</span>
    AmqpTemplate amqpTemplate<span style="color:#f92672">;</span>


    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendMiaoshaMessage</span><span style="color:#f92672">(</span>MiaoshaMessage miaoshaMessage<span style="color:#f92672">){</span>
        String msg <span style="color:#f92672">=</span> RedisService<span style="color:#f92672">.</span><span style="color:#a6e22e">beanToString</span><span style="color:#f92672">(</span>miaoshaMessage<span style="color:#f92672">);</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;miaosha send msg:&#34;</span> <span style="color:#f92672">+</span> msg<span style="color:#f92672">);</span>
        amqpTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">convertAndSend</span><span style="color:#f92672">(</span>MQConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">MIAOSHA_QUEUE</span><span style="color:#f92672">,</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
123456789
</code></pre></div><ul>
<li>用SpringBoot框架提供的AmqpTemlplate实例来为我们的秒杀队列发送消息</li>
</ul>
<h3 id="35-消息出队处理">3.5 消息出队处理</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@RabbitListener</span><span style="color:#f92672">(</span>queues <span style="color:#f92672">=</span> MQConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">MIAOSHA_QUEUE</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">receiveMiaoshaMsg</span><span style="color:#f92672">(</span>String miaoshaMessage<span style="color:#f92672">){</span>
        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;miaosha receive msg:&#34;</span> <span style="color:#f92672">+</span> miaoshaMessage<span style="color:#f92672">);</span>
        MiaoshaMessage msg <span style="color:#f92672">=</span> RedisService<span style="color:#f92672">.</span><span style="color:#a6e22e">stringToBean</span><span style="color:#f92672">(</span>miaoshaMessage<span style="color:#f92672">,</span> MiaoshaMessage<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">long</span> goodsId <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getGoodsId</span><span style="color:#f92672">();</span>
        MiaoShaUser miaoShaUser <span style="color:#f92672">=</span> msg<span style="color:#f92672">.</span><span style="color:#a6e22e">getMiaoShaUser</span><span style="color:#f92672">();</span>
        GoodsVo goodsVo <span style="color:#f92672">=</span> goodsService<span style="color:#f92672">.</span><span style="color:#a6e22e">getGoodsVoByGoodsId</span><span style="color:#f92672">(</span>goodsId<span style="color:#f92672">);</span>

        <span style="color:#75715e">//判断库存
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> stock <span style="color:#f92672">=</span> goodsVo<span style="color:#f92672">.</span><span style="color:#a6e22e">getStockCount</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>stock <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>

        <span style="color:#75715e">//有库存而且没秒杀过，开始秒杀
</span><span style="color:#75715e"></span>        miaoshaService<span style="color:#f92672">.</span><span style="color:#a6e22e">miaosha</span><span style="color:#f92672">(</span>miaoShaUser<span style="color:#f92672">,</span>goodsVo<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
1234567891011121314151617
</code></pre></div><ul>
<li>判断库存是否还有，有的话，向下执行秒杀</li>
</ul>
<h4 id="351-秒杀方法">3.5.1 秒杀方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a6e22e">@Transactional</span>
    <span style="color:#66d9ef">public</span> OrderInfo <span style="color:#a6e22e">miaosha</span><span style="color:#f92672">(</span>MiaoShaUser user<span style="color:#f92672">,</span> GoodsVo goods<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//库存减一
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">boolean</span> success <span style="color:#f92672">=</span> goodsService<span style="color:#f92672">.</span><span style="color:#a6e22e">reduceStock</span><span style="color:#f92672">(</span>goods<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>success<span style="color:#f92672">)</span>
            <span style="color:#75715e">//下订单
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> orderService<span style="color:#f92672">.</span><span style="color:#a6e22e">createOrder</span><span style="color:#f92672">(</span>user<span style="color:#f92672">,</span>goods<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
            setGoodsOver<span style="color:#f92672">(</span>goods<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">());</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
12345678910111213
</code></pre></div><ul>
<li>该方法我们用@Transactional注解标记，保证减库存和下订单都执行成功</li>
<li>注意其中有一个setGoodsOver()方法，它的作用是当该商品库存没有的时候，在redis中存一个标志，下面我们接着看</li>
</ul>
<h3 id="36-与前端进行交互的秒杀结果">3.6 与前端进行交互的秒杀结果</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * orderId 成功
</span><span style="color:#75715e">     * -1 秒杀失败
</span><span style="color:#75715e">     * 0 继续轮询
</span><span style="color:#75715e">     * @param miaoShaUser
</span><span style="color:#75715e">     * @param goodsId
</span><span style="color:#75715e">     * @return
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/result&#34;</span><span style="color:#f92672">,</span>method <span style="color:#f92672">=</span> RequestMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">GET</span><span style="color:#f92672">)</span>
    <span style="color:#a6e22e">@ResponseBody</span>
    <span style="color:#66d9ef">public</span> Result<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">miaoshaResult</span><span style="color:#f92672">(</span>MiaoShaUser miaoShaUser<span style="color:#f92672">,</span>
                                      <span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;goodsId&#34;</span><span style="color:#f92672">)</span><span style="color:#66d9ef">long</span> goodsId<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>miaoShaUser <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
            <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">error</span><span style="color:#f92672">(</span>CodeMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">SESSION_ERROR</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">long</span> result <span style="color:#f92672">=</span> miaoshaService<span style="color:#f92672">.</span><span style="color:#a6e22e">getMiaoshaResult</span><span style="color:#f92672">(</span>miaoShaUser<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span>goodsId<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">return</span> Result<span style="color:#f92672">.</span><span style="color:#a6e22e">success</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
123456789101112131415161718
</code></pre></div><ul>
<li>这里写了一个/resulet请求，前端会根据返回值，来判断秒杀的状态</li>
</ul>
<h4 id="361-getmiaosharesult方法">3.6.1 getMiaoshaResult方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getMiaoshaResult</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> userId<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> goodsId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        MiaoshaOrder order <span style="color:#f92672">=</span> orderService<span style="color:#f92672">.</span><span style="color:#a6e22e">selectMiaoshaOrderByUserIdGoodsId</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">,</span> goodsId<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>order <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            <span style="color:#75715e">//秒杀成功
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> order<span style="color:#f92672">.</span><span style="color:#a6e22e">getOrderId</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">boolean</span> isOver <span style="color:#f92672">=</span> getGoodsOver<span style="color:#f92672">(</span>goodsId<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>isOver<span style="color:#f92672">)</span>
                <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">else</span>
                <span style="color:#75715e">//继续轮询
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> 0<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
123456789101112131415
</code></pre></div><ul>
<li>用户在秒杀该商品的过程中，在得到秒杀结果之前，会一直进行轮询，直到返回orderId或者-1来告知秒杀成功与失败</li>
<li>该方法中，从数据库中看看能不能查询到秒杀订单信息，有说明秒杀成功，返回订单号；失败了则获取redis中的是否秒杀完的标志，跟前边setGoodsOver()相对应，这里的getGoodsOver()便是对set的值进行获取，如果没有库存了则说明秒杀失败了，否则要继续轮询了（已经秒杀到，但是订单还没有创建完成）</li>
</ul>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kayleh.top">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://kayleh.top/js/github-style.js"></script>



</html>