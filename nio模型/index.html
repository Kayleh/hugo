<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://kayleh.top/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://kayleh.top/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github.min.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/github-style.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/light.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/dark.css' />
    <link rel="stylesheet" href='https://kayleh.top/css/syntax.css' />
    <title>NIO blocking model - Kayleh</title>
    
    <link rel="icon" type="image/x-icon" href='https://kayleh.top/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="NIO模型 1. 概述 1.1 翻译翻译？什么叫NIO？ NIO：我认为翻译成Non-Blocking，更加的通俗直白，相比于BIO，也有一个对比，叫他非阻塞IO最好不过了
 它和BIO有以下的区别  Channel是双向的，即可以读又可以写，相比于Stream，它并不区分出输入流和输出流，而且Channel可以完成非阻塞的读写，也可以完成阻塞的读写  1.2 Buffer简介  Channel的读写是离不开Buffer的，Buffer实际上内存上一块用来读写的区域。  1.2.1 写模式  其中三个指针我们要了解一下，position为当前指针位置，limit用于读模式，用它来标记可读的最大范围，capacity是最大的可写范围阈值  当我们写数据写了四个格子时，我们执行flip()方法，即可转变为读模式，limit指针就直接变到了我们刚刚写数据的极限位置，position指针回到初始位置，这样我们就可以将数据读出来了 1.2.2 读模式到写模式的两种切换  当我们将数据全部读完时，切换到写模式 调用clear()方法，它会使position指针回到初始位置，limit回到最远端，这样就可以重新开始数据了，虽然clear意为清除，但是其实它只是将指针的位置移动了，并没有将数据清除，而是会覆盖原来的位置  只读了部分数据，我想将未读的部分保留，而现在我又要开始先进行写模式的操作了，这样可以执行compact()方法 这个方法会将没有读到的数据保存到初始位置，而position指针的位置将会移动到这些数据的后面位置，从未读的数据后开始进行写数据 之后再读数据的时候，我们就能将上次没有读到的数据读出来了  1.3 Channel简介 Channel间的数据交换，都需要依赖Buffer 1.3.1 几个重要的Channel  FileChannel：用于文件传输 ServerSocketChannel和SocketChannel：用于网络编程的传输  2. 文件拷贝实战  一个字节一个字节的拷贝实在是慢的不行。  import java.io.*; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; interface FileCopyRunner{ void copyFile(File source,File target); } public class FileCopyDemo { private static void close(Closeable closeable){ if(closeable != null) { try { closeable." />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://kayleh.top/nio%E6%A8%A1%E5%9E%8B/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="NIO blocking model - Kayleh" />
<meta name="twitter:description"
  content="NIO模型 1. 概述 1.1 翻译翻译？什么叫NIO？ NIO：我认为翻译成Non-Blocking，更加的通俗直白，相比于BIO，也有一个对比，叫他非阻塞IO最好不过了
 它和BIO有以下的区别  Channel是双向的，即可以读又可以写，相比于Stream，它并不区分出输入流和输出流，而且Channel可以完成非阻塞的读写，也可以完成阻塞的读写  1.2 Buffer简介  Channel的读写是离不开Buffer的，Buffer实际上内存上一块用来读写的区域。  1.2.1 写模式  其中三个指针我们要了解一下，position为当前指针位置，limit用于读模式，用它来标记可读的最大范围，capacity是最大的可写范围阈值  当我们写数据写了四个格子时，我们执行flip()方法，即可转变为读模式，limit指针就直接变到了我们刚刚写数据的极限位置，position指针回到初始位置，这样我们就可以将数据读出来了 1.2.2 读模式到写模式的两种切换  当我们将数据全部读完时，切换到写模式 调用clear()方法，它会使position指针回到初始位置，limit回到最远端，这样就可以重新开始数据了，虽然clear意为清除，但是其实它只是将指针的位置移动了，并没有将数据清除，而是会覆盖原来的位置  只读了部分数据，我想将未读的部分保留，而现在我又要开始先进行写模式的操作了，这样可以执行compact()方法 这个方法会将没有读到的数据保存到初始位置，而position指针的位置将会移动到这些数据的后面位置，从未读的数据后开始进行写数据 之后再读数据的时候，我们就能将上次没有读到的数据读出来了  1.3 Channel简介 Channel间的数据交换，都需要依赖Buffer 1.3.1 几个重要的Channel  FileChannel：用于文件传输 ServerSocketChannel和SocketChannel：用于网络编程的传输  2. 文件拷贝实战  一个字节一个字节的拷贝实在是慢的不行。  import java.io.*; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; interface FileCopyRunner{ void copyFile(File source,File target); } public class FileCopyDemo { private static void close(Closeable closeable){ if(closeable != null) { try { closeable." />
<meta name="twitter:site" content="https://kayleh.top" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://kayleh.top">


<meta property="og:type" content="article" />
<meta property="og:title" content="NIO blocking model - Kayleh">
<meta property="og:description"
  content="NIO模型 1. 概述 1.1 翻译翻译？什么叫NIO？ NIO：我认为翻译成Non-Blocking，更加的通俗直白，相比于BIO，也有一个对比，叫他非阻塞IO最好不过了
 它和BIO有以下的区别  Channel是双向的，即可以读又可以写，相比于Stream，它并不区分出输入流和输出流，而且Channel可以完成非阻塞的读写，也可以完成阻塞的读写  1.2 Buffer简介  Channel的读写是离不开Buffer的，Buffer实际上内存上一块用来读写的区域。  1.2.1 写模式  其中三个指针我们要了解一下，position为当前指针位置，limit用于读模式，用它来标记可读的最大范围，capacity是最大的可写范围阈值  当我们写数据写了四个格子时，我们执行flip()方法，即可转变为读模式，limit指针就直接变到了我们刚刚写数据的极限位置，position指针回到初始位置，这样我们就可以将数据读出来了 1.2.2 读模式到写模式的两种切换  当我们将数据全部读完时，切换到写模式 调用clear()方法，它会使position指针回到初始位置，limit回到最远端，这样就可以重新开始数据了，虽然clear意为清除，但是其实它只是将指针的位置移动了，并没有将数据清除，而是会覆盖原来的位置  只读了部分数据，我想将未读的部分保留，而现在我又要开始先进行写模式的操作了，这样可以执行compact()方法 这个方法会将没有读到的数据保存到初始位置，而position指针的位置将会移动到这些数据的后面位置，从未读的数据后开始进行写数据 之后再读数据的时候，我们就能将上次没有读到的数据读出来了  1.3 Channel简介 Channel间的数据交换，都需要依赖Buffer 1.3.1 几个重要的Channel  FileChannel：用于文件传输 ServerSocketChannel和SocketChannel：用于网络编程的传输  2. 文件拷贝实战  一个字节一个字节的拷贝实在是慢的不行。  import java.io.*; import java.nio.ByteBuffer; import java.nio.channels.FileChannel; interface FileCopyRunner{ void copyFile(File source,File target); } public class FileCopyDemo { private static void close(Closeable closeable){ if(closeable != null) { try { closeable." />
<meta property="og:url" content="https://kayleh.top/nio%E6%A8%A1%E5%9E%8B/" />
<meta property="og:site_name" content="NIO blocking model" />
<meta property="og:image"
  content="https://kayleh.top">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2020-12-05 11:33:46 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://kayleh.top">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://kayleh.top">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://kayleh.top">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://kayleh.top">
                  <img class=" avatar-user"
                    src="http://cdn.jsdelivr.net/gh/kayleh/cdn/img/2.jpg"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://kayleh.top">Kayleh</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://kayleh.top/nio%E6%A8%A1%E5%9E%8B/">NIO blocking model</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 05 Dec 2020 11:33:46 &#43;0800"
                    class="no-wrap">
                    Sat, 05 Dec 2020 11:33:46 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    4442 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/network">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      network
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><h1 id="nio模型">NIO模型</h1>
<h2 id="1-概述">1. 概述</h2>
<h3 id="11-翻译翻译什么叫nio">1.1 翻译翻译？什么叫NIO？</h3>
<p>NIO：我认为翻译成<code>Non-Blocking</code>，更加的通俗直白，相比于BIO，也有一个对比，叫他非阻塞IO最好不过了</p>
<ul>
<li>它和BIO有以下的区别
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721215841190.png" alt="在这里插入图片描述"></li>
<li>Channel是<code>双向</code>的，即可以读又可以写，相比于Stream，它并不区分出输入流和输出流，而且Channel可以完成非阻塞的读写，也可以完成阻塞的读写</li>
</ul>
<h3 id="12-buffer简介">1.2 Buffer简介</h3>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721220142379.png" alt="在这里插入图片描述"></p>
<ul>
<li>Channel的读写是离不开Buffer的，Buffer实际上内存上一块用来读写的区域。</li>
</ul>
<h4 id="121-写模式">1.2.1 写模式</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721220305715.png" alt="在这里插入图片描述"></p>
<ul>
<li>其中三个指针我们要了解一下，<code>position</code>为当前指针位置，<code>limit</code>用于读模式，用它来标记可读的最大范围，<code>capacity</code>是最大的可写范围阈值</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721220837981.png" alt="在这里插入图片描述"></p>
<p>当我们写数据写了四个格子时，我们执行<code>flip()</code>方法，即可转变为<code>读模式</code>，limit指针就直接变到了我们刚刚写数据的极限位置，position指针回到初始位置，这样我们就可以将数据读出来了
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721220618271.png" alt="在这里插入图片描述"></p>
<h4 id="122-读模式到写模式的两种切换">1.2.2 读模式到写模式的两种切换</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721221126713.png" alt="在这里插入图片描述"></p>
<ol>
<li>当我们将数据全部读完时，切换到写模式
调用<code>clear()</code>方法，它会使position指针回到初始位置，limit回到最远端，这样就可以重新开始数据了，虽然clear意为清除，但是其实它只是将指针的位置移动了，并没有将数据清除，而是会覆盖原来的位置
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721221133628.png" alt="在这里插入图片描述"></li>
<li>只读了部分数据，我想将未读的部分保留，而现在我又要开始先进行写模式的操作了，这样可以执行<code>compact()</code>方法
这个方法会<code>将没有读到的数据保存到初始位置</code>，而<code>position指针的位置将会移动到这些数据的后面位置</code>，从未读的数据后开始进行写数据
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721221448757.png" alt="在这里插入图片描述">
之后再读数据的时候，我们就能将上次没有读到的数据读出来了</li>
</ol>
<h3 id="13-channel简介">1.3 Channel简介</h3>
<p>Channel间的数据交换，都需要依赖Buffer
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721221615368.png" alt="在这里插入图片描述"></p>
<h4 id="131-几个重要的channel">1.3.1 几个重要的Channel</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200721221704507.png" alt="在这里插入图片描述"></p>
<ul>
<li>FileChannel：用于文件传输</li>
<li>ServerSocketChannel和SocketChannel：用于网络编程的传输</li>
</ul>
<h2 id="2-文件拷贝实战">2. 文件拷贝实战</h2>
<ul>
<li>一个字节一个字节的拷贝实在是慢的不行。</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> java.io.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.channels.FileChannel<span style="color:#f92672">;</span>

<span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">FileCopyRunner</span><span style="color:#f92672">{</span>
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>File source<span style="color:#f92672">,</span>File target<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileCopyDemo</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">(</span>Closeable closeable<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>closeable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                closeable<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//不使用任何缓冲的留的拷贝
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> FileCopyRunner noBufferStreamCopy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileCopyRunner<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>File source<span style="color:#f92672">,</span> File target<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            InputStream fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            OutputStream fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
                fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>target<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">int</span> result<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">while</span><span style="color:#f92672">((</span>result <span style="color:#f92672">=</span> fin<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">){</span>
                    fout<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                close<span style="color:#f92672">(</span>fin<span style="color:#f92672">);</span>
                close<span style="color:#f92672">(</span>fout<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">};</span>

    <span style="color:#75715e">//使用缓冲区的流的拷贝
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> FileCopyRunner bufferStreamCopy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileCopyRunner<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>File source<span style="color:#f92672">,</span> File target<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            InputStream fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            OutputStream fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>source<span style="color:#f92672">);</span>
                fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>target<span style="color:#f92672">);</span>
                <span style="color:#75715e">//创建缓冲区
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> buffer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>1024<span style="color:#f92672">];</span>
                <span style="color:#66d9ef">int</span> result<span style="color:#f92672">;</span>
                <span style="color:#66d9ef">while</span><span style="color:#f92672">((</span>result <span style="color:#f92672">=</span> fin<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>buffer<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
                    <span style="color:#75715e">//result这里表示从中读出来的具体字节数
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">//虽然缓冲区中能缓存1024，但是我们读取的时候不一定就有这么多字节
</span><span style="color:#75715e"></span>                    <span style="color:#75715e">//所以我们使用result做下面的参数
</span><span style="color:#75715e"></span>                    fout<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buffer<span style="color:#f92672">,</span>0<span style="color:#f92672">,</span>result<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                close<span style="color:#f92672">(</span>fin<span style="color:#f92672">);</span>
                close<span style="color:#f92672">(</span>fout<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">};</span>

    <span style="color:#75715e">//使用带有缓冲区的channel复制 nio
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> FileCopyRunner nioBufferCopy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileCopyRunner<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#a6e22e">@Override</span>
        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>File source<span style="color:#f92672">,</span> File target<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            FileChannel fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            FileChannel fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>source<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
                fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>target<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
                ByteBuffer byteBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>1024<span style="color:#f92672">);</span>

                <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>fin<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">){</span>
                    byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span><span style="color:#75715e">//转变为读模式
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">hasRemaining</span><span style="color:#f92672">()){</span>
                        fout<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>byteBuffer<span style="color:#f92672">);</span>
                    <span style="color:#f92672">}</span>
                    byteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span><span style="color:#75715e">//转变为写模式
</span><span style="color:#75715e"></span>                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
                close<span style="color:#f92672">(</span>fin<span style="color:#f92672">);</span>
                close<span style="color:#f92672">(</span>fout<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">};</span>

    <span style="color:#75715e">//使用没有缓冲区的channel复制文件
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> FileCopyRunner nioTransferCopy <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>source<span style="color:#f92672">,</span> target<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
        FileChannel fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        FileChannel fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>

        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            fin <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileInputStream<span style="color:#f92672">(</span>source<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>
            fout <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileOutputStream<span style="color:#f92672">(</span>target<span style="color:#f92672">).</span><span style="color:#a6e22e">getChannel</span><span style="color:#f92672">();</span>

            <span style="color:#66d9ef">long</span> transferred <span style="color:#f92672">=</span> 0L<span style="color:#f92672">;</span>
            <span style="color:#66d9ef">long</span> size <span style="color:#f92672">=</span> fin<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>transferred <span style="color:#f92672">!=</span> size<span style="color:#f92672">){</span>
                <span style="color:#75715e">//如果拷贝的大小没有达到源文件的大小就要一直拷贝
</span><span style="color:#75715e"></span>                transferred <span style="color:#f92672">+=</span> fin<span style="color:#f92672">.</span><span style="color:#a6e22e">transferTo</span><span style="color:#f92672">(</span>0<span style="color:#f92672">,</span>size<span style="color:#f92672">,</span>fout<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            close<span style="color:#f92672">(</span>fin<span style="color:#f92672">);</span>
            close<span style="color:#f92672">(</span>fout<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        File source <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;J:\\StudySpace\\Java秒杀系统方案优化-高性能高并发实战\\project.zip&#34;</span><span style="color:#f92672">);</span>
        File target <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;J:\\StudySpace\\Java秒杀系统方案优化-高性能高并发实战\\p1.zip&#34;</span><span style="color:#f92672">);</span>
        File target2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;J:\\StudySpace\\Java秒杀系统方案优化-高性能高并发实战\\p2.zip&#34;</span><span style="color:#f92672">);</span>
        File target3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;J:\\StudySpace\\Java秒杀系统方案优化-高性能高并发实战\\p3.zip&#34;</span><span style="color:#f92672">);</span>
        File target4 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;J:\\StudySpace\\Java秒杀系统方案优化-高性能高并发实战\\p4.zip&#34;</span><span style="color:#f92672">);</span>

        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> noBufferStreamCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>source<span style="color:#f92672">,</span>target<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> bufferStreamCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>source<span style="color:#f92672">,</span>target2<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> nioBufferCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>source<span style="color:#f92672">,</span>target3<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> nioTransferCopy<span style="color:#f92672">.</span><span style="color:#a6e22e">copyFile</span><span style="color:#f92672">(</span>source<span style="color:#f92672">,</span>target4<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>


</code></pre></div><h2 id="3-selector概述">3. Selector概述</h2>
<ul>
<li>Channel需要在Selector上注册
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722145734223.png" alt="在这里插入图片描述"></li>
<li>注册的同时，要告诉Selector监听的状态
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722145833687.png" alt="在这里插入图片描述"></li>
<li>Channel对应的状态有：<code>CONNECT</code>：socketChannel已经与服务器建立连接的状态；<code>ACCEPT</code>：serverSocketChannel已经与客户端建立连接的状态；<code>READ</code>：可读状态；<code>WRITE</code>：可写状态
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722150046897.png" alt="在这里插入图片描述"></li>
<li>Channel在Selector上注册完成后，会返回一个SelectKey对象，其中有几个重要的方法：<code>interestOps</code>：查看注册的Channel绑定的状态；<code>readyOps</code>：查看哪些是可操作的状态；<code>channel</code>：返回channel对象；<code>selector</code>：返回selector对象；<code>attachment</code>：附加其他对象<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722150611349.png" alt="在这里插入图片描述"></li>
<li>调用Selector的select方法，返回它监听的事件的数量，可同时响应多个事件。不过它是阻塞式的调用，当监听的事件中没有可以用来响应请求的，则会被阻塞，直到有可用的channel能够响应该请求，才会返回
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722150651862.png" alt="在这里插入图片描述"></li>
</ul>
<h1 id="实战">实战</h1>
<h2 id="1-nio模型分析">1. NIO模型分析</h2>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/202007222229375.png" alt="在这里插入图片描述"></p>
<ul>
<li>在服务器端创建一个<code>Selector</code>，将<code>ServerSocketChannel注册到Selector上</code>，被Selector监听的事件为<code>Accept</code></li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722222907340.png" alt="在这里插入图片描述"></p>
<ul>
<li>Client1请求与服务器建立连接，Selector接收到Accept事件，服务器端对其进行处理（handles），服务器与客户端连接成功</li>
</ul>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722223243146.png" alt="在这里插入图片描述"></p>
<ul>
<li>建立连接过程中，服务器通道（ServerSocketChannel）调用<code>accept方法</code>，获取到与客户端进行连接的通道（<code>SocketChannel</code>），也将其<code>注册到Selector</code>上，<code>监听READ事件</code>，这样，客户端向服务器发送消息，就能触发该READ事件进行响应，读取该消息。</li>
</ul>
<blockquote>
<p>Tips: 我们处理这个建立连接并接收从客户端传过来的消息，都是在<code>一个线程</code>内完成的。在bio中，则会为单个客户端单独开辟一个线程，用于处理消息，并且客户端在不发送消息的过程中，该线程一直是阻塞的。</p>
</blockquote>
<hr>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722223923471.png" alt="在这里插入图片描述"></p>
<ul>
<li>同样，两个客户连接过来也是一个线程在起作用，将客户端2的SocketChannel注册到服务器的Selector，并监听READ事件，随时响应随时处理。即一个客户端有一个SocketChannel，两个客户端就有两个SocketChannel，这个就是我们使用nio编程模型来用一个selector对象在一个线程里边监听以及处理多个通道的io的操作</li>
</ul>
<hr>
<p>各个Channel是被配置为<code>非阻塞式</code>的（configureBlocking(false)），但是Selector本身调用的<code>select()方法</code>，它是<code>阻塞式</code>的，当监听在Selector上的事件都没有触发时，那么它就会被阻塞，直到有事件对其进行响应</p>
<h2 id="2-聊天室项目代码重点知识">2. 聊天室项目代码重点知识</h2>
<h3 id="21-服务器端">2.1 服务器端</h3>
<h4 id="211-字段">2.1.1 字段</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/2020072222584984.png" alt="在这里插入图片描述"></p>
<h4 id="212-主方法">2.1.2 主方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722230412178.png" alt="在这里插入图片描述"></p>
<h4 id="213-处理方法">2.1.3 处理方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722230845441.png" alt="在这里插入图片描述"></p>
<h4 id="214-转发消息方法">2.1.4 转发消息方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722233104941.png" alt="在这里插入图片描述"></p>
<h4 id="215-接收消息方法">2.1.5 接收消息方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722231319234.png" alt="在这里插入图片描述"></p>
<h3 id="22-客户端">2.2 客户端</h3>
<h4 id="221-字段">2.2.1 字段</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722231507769.png" alt="在这里插入图片描述"></p>
<h4 id="222-主方法">2.2.2 主方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722231820775.png" alt="在这里插入图片描述"></p>
<h4 id="223-处理方法">2.2.3 处理方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/202007222330187.png" alt="在这里插入图片描述"></p>
<h4 id="224-接收方法">2.2.4 接收方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722233204365.png" alt="在这里插入图片描述"></p>
<h4 id="225-发送方法">2.2.5 发送方法</h4>
<p><img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722233310845.png" alt="在这里插入图片描述"></p>
<hr>
<h2 id="3-测试结果">3. 测试结果</h2>
<ul>
<li>服务器端显示信息正确
<img src="https://cdn.jsdelivr.net/gh/kayleh/cdn2/IO/NIO%E6%A8%A1%E5%9E%8B/20200722233342438.png" alt="在这里插入图片描述"></li>
</ul>
<h2 id="4-完整代码">4. 完整代码</h2>
<h3 id="41-服务器端">4.1 服务器端</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> server<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.Closeable<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.net.InetSocketAddress<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.channels.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.charset.Charset<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.charset.StandardCharsets<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Set<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatServer</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_PORT <span style="color:#f92672">=</span> 8888<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String QUIT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;quit&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> BUFFER <span style="color:#f92672">=</span> 1024<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> ServerSocketChannel serverSocketChannel<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Selector selector<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> ByteBuffer rBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>BUFFER<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">private</span> ByteBuffer wBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>BUFFER<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">private</span> Charset charset <span style="color:#f92672">=</span> Charset<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>StandardCharsets<span style="color:#f92672">.</span><span style="color:#a6e22e">UTF_8</span><span style="color:#f92672">));</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatServer</span><span style="color:#f92672">(){</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>DEFAULT_PORT<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatServer</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">readyToQuit</span><span style="color:#f92672">(</span>String msg<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">return</span> QUIT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">(</span>Closeable closeable<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>closeable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                closeable<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//创建ServerSocketChannel通道
</span><span style="color:#75715e"></span>            serverSocketChannel <span style="color:#f92672">=</span> ServerSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">//设置非阻塞模式，默认情况也是阻塞调用的
</span><span style="color:#75715e"></span>            serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">//绑定端口号
</span><span style="color:#75715e"></span>            serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">bind</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>port<span style="color:#f92672">));</span>
            <span style="color:#75715e">//创建selector
</span><span style="color:#75715e"></span>            selector <span style="color:#f92672">=</span> Selector<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">//将accept事件注册到selector上
</span><span style="color:#75715e"></span>            serverSocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span> SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_ACCEPT</span><span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;服务器启动成功，监听端口号：&#34;</span> <span style="color:#f92672">+</span> port <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>

            <span style="color:#75715e">//开始进入监听模式
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">){</span>
                <span style="color:#75715e">//阻塞式调用
</span><span style="color:#75715e"></span>                selector<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">();</span>

                <span style="color:#75715e">//获取所有的监听事件，
</span><span style="color:#75715e"></span>                Set<span style="color:#f92672">&lt;</span>SelectionKey<span style="color:#f92672">&gt;</span> selectionKeys <span style="color:#f92672">=</span> selector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectedKeys</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SelectionKey selectionKey <span style="color:#f92672">:</span> selectionKeys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">//处理事件
</span><span style="color:#75715e"></span>                    handles<span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                <span style="color:#75715e">//将已经处理完成的事件进行清空
</span><span style="color:#75715e"></span>                selectionKeys<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            close<span style="color:#f92672">(</span>selector<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 处理事件 处理accept事件 和 read事件
</span><span style="color:#75715e">     * @param selectionKey 与selector绑定的channel的key
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handles</span><span style="color:#f92672">(</span>SelectionKey selectionKey<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">isAcceptable</span><span style="color:#f92672">()){</span>
            <span style="color:#75715e">//处理accept事件
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//先要获取ServerSocketChannel
</span><span style="color:#75715e"></span>            ServerSocketChannel server <span style="color:#f92672">=(</span>ServerSocketChannel<span style="color:#f92672">)</span> selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
            <span style="color:#75715e">// 我觉得这样写也行 直接调用全局变量 SocketChannel socketChannel = serverSocketChannel.accept();
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//获取对应的客户端的通道
</span><span style="color:#75715e"></span>            SocketChannel socketChannel <span style="color:#f92672">=</span> server<span style="color:#f92672">.</span><span style="color:#a6e22e">accept</span><span style="color:#f92672">();</span>
            socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">//将客户端通道绑定到selector上，监听read事件
</span><span style="color:#75715e"></span>            socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_READ</span><span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;客户端&#34;</span> <span style="color:#f92672">+</span> socketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;:已经连接&#34;</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">isReadable</span><span style="color:#f92672">()){</span>
            <span style="color:#75715e">//处理read事件
</span><span style="color:#75715e"></span>            SocketChannel clientChannel <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SocketChannel<span style="color:#f92672">)</span> selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
            String fwdMsg <span style="color:#f92672">=</span> receive<span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">);</span>

            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>fwdMsg<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()){</span>
                <span style="color:#75715e">//接不到消息了，那么就把这个通道给他移除了
</span><span style="color:#75715e"></span>                selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">//通知selector有注册的通道被移除了，更新状态
</span><span style="color:#75715e"></span>                selector<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">//转发消息
</span><span style="color:#75715e"></span>                forwardMessage<span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">,</span>fwdMsg<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>readyToQuit<span style="color:#f92672">(</span>fwdMsg<span style="color:#f92672">)){</span>
                    selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">cancel</span><span style="color:#f92672">();</span>
                    selector<span style="color:#f92672">.</span><span style="color:#a6e22e">wakeup</span><span style="color:#f92672">();</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 转发消息
</span><span style="color:#75715e">     * @param clientChannel 客户端通道
</span><span style="color:#75715e">     * @param fwdMsg 转发的消息
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">forwardMessage</span><span style="color:#f92672">(</span>SocketChannel clientChannel<span style="color:#f92672">,</span> String fwdMsg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//keys方法区别于selectedKeys,这个方法返回的是接下来需要被处理的通道key
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//而keys则返回与selector绑定的所有通道key
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//跳过ServerSocketChannel和本身
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SelectionKey selectionKey <span style="color:#f92672">:</span> selector<span style="color:#f92672">.</span><span style="color:#a6e22e">keys</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            SelectableChannel channel <span style="color:#f92672">=</span> selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>channel <span style="color:#66d9ef">instanceof</span> ServerSocketChannel<span style="color:#f92672">)</span>
                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;客户端&#34;</span> <span style="color:#f92672">+</span> clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;：&#34;</span> <span style="color:#f92672">+</span> fwdMsg<span style="color:#f92672">);</span>
            <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">)){</span>
                wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">//写入消息
</span><span style="color:#75715e"></span>                wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>charset<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;客户端&#34;</span> <span style="color:#f92672">+</span> clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">socket</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;：&#34;</span> <span style="color:#f92672">+</span> fwdMsg<span style="color:#f92672">));</span>
                <span style="color:#75715e">//转换为读模式
</span><span style="color:#75715e"></span>                wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
                <span style="color:#75715e">//有数据就一直读
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">hasRemaining</span><span style="color:#f92672">())</span>
                    <span style="color:#f92672">((</span>SocketChannel<span style="color:#f92672">)</span>channel<span style="color:#f92672">).</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>wBuffer<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * 从客户通道上读取消息
</span><span style="color:#75715e">     * @param clientChannel 客户通道
</span><span style="color:#75715e">     * @return 消息
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">receive</span><span style="color:#f92672">(</span>SocketChannel clientChannel<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//将当前指针置于初始位置，覆盖已有的消息（清空消息）
</span><span style="color:#75715e"></span>        rBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//不停的向缓存中写
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>rBuffer<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">);</span>
        <span style="color:#75715e">//由写模式到读模式
</span><span style="color:#75715e"></span>        rBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>charset<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>rBuffer<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ChatServer chatServer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChatServer<span style="color:#f92672">();</span>
        chatServer<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="42-客户端">4.2 客户端</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> client<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.Closeable<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.net.InetSocketAddress<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.ByteBuffer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.channels.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.charset.Charset<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.charset.StandardCharsets<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.Set<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChatClient</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String DEFAULT_SERVER_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_SERVER_PORT <span style="color:#f92672">=</span> 8888<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String QUIT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;quit&#34;</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> BUFFER <span style="color:#f92672">=</span> 1024<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> String host<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> SocketChannel clientChannel<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Selector selector<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> ByteBuffer rBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>BUFFER<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">private</span> ByteBuffer wBuffer <span style="color:#f92672">=</span> ByteBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">allocate</span><span style="color:#f92672">(</span>BUFFER<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">private</span> Charset charset <span style="color:#f92672">=</span> Charset<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>StandardCharsets<span style="color:#f92672">.</span><span style="color:#a6e22e">UTF_8</span><span style="color:#f92672">));</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatClient</span><span style="color:#f92672">(</span>String host<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> host<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> port<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ChatClient</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>DEFAULT_SERVER_HOST<span style="color:#f92672">,</span>DEFAULT_SERVER_PORT<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">readyToQuit</span><span style="color:#f92672">(</span>String msg<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">return</span> QUIT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">(</span>Closeable closeable<span style="color:#f92672">){</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>closeable <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                closeable<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start</span><span style="color:#f92672">(){</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//创建用户通道
</span><span style="color:#75715e"></span>            clientChannel <span style="color:#f92672">=</span> SocketChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
            clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">configureBlocking</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span><span style="color:#75715e">//这一步千万不能忘了
</span><span style="color:#75715e"></span>            <span style="color:#75715e">//创建selector，并且将用户通道的connect请求注册上去
</span><span style="color:#75715e"></span>            selector <span style="color:#f92672">=</span> Selector<span style="color:#f92672">.</span><span style="color:#a6e22e">open</span><span style="color:#f92672">();</span>
            clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span> SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_CONNECT</span><span style="color:#f92672">);</span>
            <span style="color:#75715e">//尝试与服务器创建连接
</span><span style="color:#75715e"></span>            clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">connect</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InetSocketAddress<span style="color:#f92672">(</span>host<span style="color:#f92672">,</span>port<span style="color:#f92672">));</span>

            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>selector<span style="color:#f92672">.</span><span style="color:#a6e22e">isOpen</span><span style="color:#f92672">()){</span>
                <span style="color:#75715e">//一直监听selector上注册的channel请求
</span><span style="color:#75715e"></span>                selector<span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">();</span>

                Set<span style="color:#f92672">&lt;</span>SelectionKey<span style="color:#f92672">&gt;</span> selectionKeys <span style="color:#f92672">=</span> selector<span style="color:#f92672">.</span><span style="color:#a6e22e">selectedKeys</span><span style="color:#f92672">();</span>
                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SelectionKey selectionKey <span style="color:#f92672">:</span> selectionKeys<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                    <span style="color:#75715e">//响应请求
</span><span style="color:#75715e"></span>                    handles<span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
                selectionKeys<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ClosedSelectorException e<span style="color:#f92672">){</span>

        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
            close<span style="color:#f92672">(</span>selector<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handles</span><span style="color:#f92672">(</span>SelectionKey selectionKey<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#75715e">//处理connect事件
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">isConnectable</span><span style="color:#f92672">()){</span>
            <span style="color:#75715e">//如果能够与服务器响应了
</span><span style="color:#75715e"></span>            SocketChannel channel <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SocketChannel<span style="color:#f92672">)</span> selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>channel<span style="color:#f92672">.</span><span style="color:#a6e22e">isConnectionPending</span><span style="color:#f92672">()){</span>
                channel<span style="color:#f92672">.</span><span style="color:#a6e22e">finishConnect</span><span style="color:#f92672">();</span> <span style="color:#75715e">//正式建立连接
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> UserInputHandler<span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
            channel<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>selector<span style="color:#f92672">,</span>SelectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">OP_READ</span><span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">isReadable</span><span style="color:#f92672">()){</span>
            String msg <span style="color:#f92672">=</span> receive<span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">);</span>
            SocketChannel channel <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>SocketChannel<span style="color:#f92672">)</span> selectionKey<span style="color:#f92672">.</span><span style="color:#a6e22e">channel</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">()){</span>
                <span style="color:#75715e">//服务端异常
</span><span style="color:#75715e"></span>                close<span style="color:#f92672">(</span>selector<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#75715e">//TODO 看看这里信息对不对
</span><span style="color:#75715e"></span>                System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>

        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">receive</span><span style="color:#f92672">(</span>SocketChannel clientChannel<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        rBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">//一直读数据
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>rBuffer<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">);</span>
        rBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">return</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>charset<span style="color:#f92672">.</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>rBuffer<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>String msg<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span>
            <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>

        wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
        wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>charset<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">));</span>
        wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">flip</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>wBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">hasRemaining</span><span style="color:#f92672">()){</span>
            clientChannel<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>wBuffer<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>

        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>QUIT<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">))</span>
            close<span style="color:#f92672">(</span>selector<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ChatClient chatClient <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChatClient<span style="color:#f92672">();</span>
        chatClient<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><h3 id="43-客户端监听用户输入进程">4.3 客户端监听用户输入进程</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">package</span> client<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.BufferedReader<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.IOException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.InputStreamReader<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserInputHandler</span> <span style="color:#66d9ef">implements</span> Runnable<span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> ChatClient chatClient<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserInputHandler</span><span style="color:#f92672">(</span>ChatClient chatClient<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">chatClient</span> <span style="color:#f92672">=</span> chatClient<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//等待用户输入信息
</span><span style="color:#75715e"></span>        BufferedReader consoleReader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">in</span><span style="color:#f92672">));</span>

        <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">){</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                String msg <span style="color:#f92672">=</span> consoleReader<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">();</span>
                chatClient<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>chatClient<span style="color:#f92672">.</span><span style="color:#a6e22e">readyToQuit</span><span style="color:#f92672">(</span>msg<span style="color:#f92672">))</span> <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://kayleh.top">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://kayleh.top/js/github-style.js"></script>



</html>